(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function i(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(r){if(r.ep)return;r.ep=!0;const o=i(r);fetch(r.href,o)}})();var $n=Object.defineProperty,Hn=(e,t,i)=>t in e?$n(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,rt=(e,t,i)=>Hn(e,typeof t!="symbol"?t+"":t,i);class Ii{unwrap(t,i){const n=this._chain(r=>w.ok(t?t(r):r),r=>i?w.ok(i(r)):w.err(r));if(n.isErr)throw n.error;return n.value}map(t,i){return this._chain(n=>w.ok(t(n)),n=>w.err(i?i(n):n))}chain(t,i){return this._chain(t,i||(n=>w.err(n)))}}class jn extends Ii{constructor(t){super(),this.value=void 0,this.isOk=!0,this.isErr=!1,this.value=t}_chain(t,i){return t(this.value)}}class Un extends Ii{constructor(t){super(),this.error=void 0,this.isOk=!1,this.isErr=!0,this.error=t}_chain(t,i){return i(this.error)}}var w;(function(e){e.ok=function(t){return new jn(t)},e.err=function(t){return new Un(t||new Error)},e.all=function(t){if(Array.isArray(t)){const r=[];for(let o=0;o<t.length;o++){const s=t[o];if(s.isErr)return s;r.push(s.value)}return e.ok(r)}const i={},n=Object.keys(t);for(let r=0;r<n.length;r++){const o=t[n[r]];if(o.isErr)return o;i[n[r]]=o.value}return e.ok(i)}})(w||(w={}));const hi=e=>(e=e-(e>>>1&1431655765),e=(e&858993459)+(e>>>2&858993459),Math.imul(e+(e>>>4)&252645135,16843009)>>24),Se=e=>(e=e>>>8&16711935|(e&16711935)<<8,e>>>16&65535|(e&65535)<<16),li=e=>(e=e>>>1&1431655765|(e&1431655765)<<1,e=e>>>2&858993459|(e&858993459)<<2,e=e>>>4&252645135|(e&252645135)<<4,Se(e));class h{constructor(t,i){this.lo=t|0,this.hi=i|0}static fromSquare(t){return t>=32?new h(0,1<<t-32):new h(1<<t,0)}static fromRank(t){return new h(255,0).shl64(8*t)}static fromFile(t){return new h(16843009<<t,16843009<<t)}static empty(){return new h(0,0)}static full(){return new h(4294967295,4294967295)}static corners(){return new h(129,2164260864)}static center(){return new h(402653184,24)}static backranks(){return new h(255,4278190080)}static backrank(t){return t==="white"?new h(255,0):new h(0,4278190080)}static lightSquares(){return new h(1437226410,1437226410)}static darkSquares(){return new h(2857740885,2857740885)}complement(){return new h(~this.lo,~this.hi)}xor(t){return new h(this.lo^t.lo,this.hi^t.hi)}union(t){return new h(this.lo|t.lo,this.hi|t.hi)}intersect(t){return new h(this.lo&t.lo,this.hi&t.hi)}diff(t){return new h(this.lo&~t.lo,this.hi&~t.hi)}intersects(t){return this.intersect(t).nonEmpty()}isDisjoint(t){return this.intersect(t).isEmpty()}supersetOf(t){return t.diff(this).isEmpty()}subsetOf(t){return this.diff(t).isEmpty()}shr64(t){return t>=64?h.empty():t>=32?new h(this.hi>>>t-32,0):t>0?new h(this.lo>>>t^this.hi<<32-t,this.hi>>>t):this}shl64(t){return t>=64?h.empty():t>=32?new h(0,this.lo<<t-32):t>0?new h(this.lo<<t,this.hi<<t^this.lo>>>32-t):this}bswap64(){return new h(Se(this.hi),Se(this.lo))}rbit64(){return new h(li(this.hi),li(this.lo))}minus64(t){const i=this.lo-t.lo,n=(i&t.lo&1)+(t.lo>>>1)+(i>>>1)>>>31;return new h(i,this.hi-(t.hi+n))}equals(t){return this.lo===t.lo&&this.hi===t.hi}size(){return hi(this.lo)+hi(this.hi)}isEmpty(){return this.lo===0&&this.hi===0}nonEmpty(){return this.lo!==0||this.hi!==0}has(t){return(t>=32?this.hi&1<<t-32:this.lo&1<<t)!==0}set(t,i){return i?this.with(t):this.without(t)}with(t){return t>=32?new h(this.lo,this.hi|1<<t-32):new h(this.lo|1<<t,this.hi)}without(t){return t>=32?new h(this.lo,this.hi&~(1<<t-32)):new h(this.lo&~(1<<t),this.hi)}toggle(t){return t>=32?new h(this.lo,this.hi^1<<t-32):new h(this.lo^1<<t,this.hi)}last(){if(this.hi!==0)return 63-Math.clz32(this.hi);if(this.lo!==0)return 31-Math.clz32(this.lo)}first(){if(this.lo!==0)return 31-Math.clz32(this.lo&-this.lo);if(this.hi!==0)return 63-Math.clz32(this.hi&-this.hi)}withoutFirst(){return this.lo!==0?new h(this.lo&this.lo-1,this.hi):new h(0,this.hi&this.hi-1)}moreThanOne(){return this.hi!==0&&this.lo!==0||(this.lo&this.lo-1)!==0||(this.hi&this.hi-1)!==0}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let t=this.lo,i=this.hi;for(;t!==0;){const n=31-Math.clz32(t&-t);t^=1<<n,yield n}for(;i!==0;){const n=31-Math.clz32(i&-i);i^=1<<n,yield 32+n}}*reversed(){let t=this.lo,i=this.hi;for(;i!==0;){const n=31-Math.clz32(i);i^=1<<n,yield 32+n}for(;t!==0;){const n=31-Math.clz32(t);t^=1<<n,yield n}}}const $i=["a","b","c","d","e","f","g","h"],Vn=["1","2","3","4","5","6","7","8"],tt=["white","black"],_=["pawn","knight","bishop","rook","queen","king"],Qn=["a","h"],ee=e=>"role"in e,v=e=>e!==void 0,R=e=>e==="white"?"black":"white",Gt=e=>e>>3,it=e=>e&7,Oe=(e,t)=>0<=e&&e<8&&0<=t&&t<8?e+8*t:void 0,Hi=e=>{switch(e){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function Ot(e){switch(e.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function ct(e){if(e.length===2)return Oe(e.charCodeAt(0)-97,e.charCodeAt(1)-49)}const At=e=>$i[it(e)]+Vn[Gt(e)],Wn=e=>{if(e[1]==="@"&&e.length===4){const t=Ot(e[0]),i=ct(e.slice(2));if(t&&v(i))return{role:t,to:i}}else if(e.length===4||e.length===5){const t=ct(e.slice(0,2)),i=ct(e.slice(2,4));let n;if(e.length===5&&(n=Ot(e[4]),!n))return;if(v(t)&&v(i))return{from:t,to:i,promotion:n}}},Qe=(e,t)=>e==="white"?t==="a"?2:6:t==="a"?58:62,We=(e,t)=>e==="white"?t==="a"?3:5:t==="a"?59:61,ie=(e,t)=>{let i=h.empty();for(const n of t){const r=e+n;0<=r&&r<64&&Math.abs(it(e)-it(r))<=2&&(i=i.with(r))}return i},dt=e=>{const t=[];for(let i=0;i<64;i++)t[i]=e(i);return t},Gn=dt(e=>ie(e,[-9,-8,-7,-1,1,7,8,9])),Zn=dt(e=>ie(e,[-17,-15,-10,-6,6,10,15,17])),Yn={white:dt(e=>ie(e,[7,9])),black:dt(e=>ie(e,[-7,-9]))},zt=e=>Gn[e],Ge=e=>Zn[e],Lt=(e,t)=>Yn[e][t],Ae=dt(e=>h.fromFile(it(e)).without(e)),Re=dt(e=>h.fromRank(Gt(e)).without(e)),xe=dt(e=>{const t=new h(134480385,2151686160),i=8*(Gt(e)-it(e));return(i>=0?t.shl64(i):t.shr64(-i)).without(e)}),ze=dt(e=>{const t=new h(270549120,16909320),i=8*(Gt(e)+it(e)-7);return(i>=0?t.shl64(i):t.shr64(-i)).without(e)}),qe=(e,t,i)=>{let n=i.intersect(t),r=n.bswap64();return n=n.minus64(e),r=r.minus64(e.bswap64()),n.xor(r.bswap64()).intersect(t)},Xn=(e,t)=>qe(h.fromSquare(e),Ae[e],t),Jn=(e,t)=>{const i=Re[e];let n=t.intersect(i),r=n.rbit64();return n=n.minus64(h.fromSquare(e)),r=r.minus64(h.fromSquare(63-e)),n.xor(r.rbit64()).intersect(i)},jt=(e,t)=>{const i=h.fromSquare(e);return qe(i,xe[e],t).xor(qe(i,ze[e],t))},Ut=(e,t)=>Xn(e,t).xor(Jn(e,t)),ji=(e,t)=>jt(e,t).xor(Ut(e,t)),Ui=(e,t,i)=>{switch(e.role){case"pawn":return Lt(e.color,t);case"knight":return Ge(t);case"bishop":return jt(t,i);case"rook":return Ut(t,i);case"queen":return ji(t,i);case"king":return zt(t)}},Vi=(e,t)=>{const i=h.fromSquare(t);return Re[e].intersects(i)?Re[e].with(e):ze[e].intersects(i)?ze[e].with(e):xe[e].intersects(i)?xe[e].with(e):Ae[e].intersects(i)?Ae[e].with(e):h.empty()},qt=(e,t)=>Vi(e,t).intersect(h.full().shl64(e).xor(h.full().shl64(t))).withoutFirst();class ht{constructor(){}static default(){const t=new ht;return t.reset(),t}reset(){this.occupied=new h(65535,4294901760),this.promoted=h.empty(),this.white=new h(65535,0),this.black=new h(0,4294901760),this.pawn=new h(65280,16711680),this.knight=new h(66,1107296256),this.bishop=new h(36,603979776),this.rook=new h(129,2164260864),this.queen=new h(8,134217728),this.king=new h(16,268435456)}static empty(){const t=new ht;return t.clear(),t}clear(){this.occupied=h.empty(),this.promoted=h.empty();for(const t of tt)this[t]=h.empty();for(const t of _)this[t]=h.empty()}clone(){const t=new ht;t.occupied=this.occupied,t.promoted=this.promoted;for(const i of tt)t[i]=this[i];for(const i of _)t[i]=this[i];return t}getColor(t){if(this.white.has(t))return"white";if(this.black.has(t))return"black"}getRole(t){for(const i of _)if(this[i].has(t))return i}get(t){const i=this.getColor(t);if(!i)return;const n=this.getRole(t),r=this.promoted.has(t);return{color:i,role:n,promoted:r}}take(t){const i=this.get(t);return i&&(this.occupied=this.occupied.without(t),this[i.color]=this[i.color].without(t),this[i.role]=this[i.role].without(t),i.promoted&&(this.promoted=this.promoted.without(t))),i}set(t,i){const n=this.take(t);return this.occupied=this.occupied.with(t),this[i.color]=this[i.color].with(t),this[i.role]=this[i.role].with(t),i.promoted&&(this.promoted=this.promoted.with(t)),n}has(t){return this.occupied.has(t)}*[Symbol.iterator](){for(const t of this.occupied)yield[t,this.get(t)]}pieces(t,i){return this[t].intersect(this[i])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(t){return this.pieces(t,"king").singleSquare()}}var B;(function(e){e.Empty="ERR_EMPTY",e.OppositeCheck="ERR_OPPOSITE_CHECK",e.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",e.Kings="ERR_KINGS",e.Variant="ERR_VARIANT"})(B||(B={}));class L extends Error{}const _n=(e,t,i,n)=>i[t].intersect(Ut(e,n).intersect(i.rooksAndQueens()).union(jt(e,n).intersect(i.bishopsAndQueens())).union(Ge(e).intersect(i.knight)).union(zt(e).intersect(i.king)).union(Lt(R(t),e).intersect(i.pawn)));class Y{constructor(){}static default(){const t=new Y;return t.castlingRights=h.corners(),t.rook={white:{a:0,h:7},black:{a:56,h:63}},t.path={white:{a:new h(14,0),h:new h(96,0)},black:{a:new h(0,234881024),h:new h(0,1610612736)}},t}static empty(){const t=new Y;return t.castlingRights=h.empty(),t.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},t.path={white:{a:h.empty(),h:h.empty()},black:{a:h.empty(),h:h.empty()}},t}clone(){const t=new Y;return t.castlingRights=this.castlingRights,t.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},t.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},t}add(t,i,n,r){const o=Qe(t,i),s=We(t,i);this.castlingRights=this.castlingRights.with(r),this.rook[t][i]=r,this.path[t][i]=qt(r,s).with(s).union(qt(n,o).with(o)).without(n).without(r)}static fromSetup(t){const i=Y.empty(),n=t.castlingRights.intersect(t.board.rook);for(const r of tt){const o=h.backrank(r),s=t.board.kingOf(r);if(!v(s)||!o.has(s))continue;const a=n.intersect(t.board[r]).intersect(o),l=a.first();v(l)&&l<s&&i.add(r,"a",s,l);const c=a.last();v(c)&&s<c&&i.add(r,"h",s,c)}return i}discardRook(t){if(this.castlingRights.has(t)){this.castlingRights=this.castlingRights.without(t);for(const i of tt)for(const n of Qn)this.rook[i][n]===t&&(this.rook[i][n]=void 0)}}discardColor(t){this.castlingRights=this.castlingRights.diff(h.backrank(t)),this.rook[t].a=void 0,this.rook[t].h=void 0}}class pt{constructor(t){this.rules=t}reset(){this.board=ht.default(),this.pockets=void 0,this.turn="white",this.castles=Y.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){this.board=t.board.clone(),this.board.promoted=h.empty(),this.pockets=void 0,this.turn=t.turn,this.castles=Y.fromSetup(t),this.epSquare=tr(this,t.epSquare),this.remainingChecks=void 0,this.halfmoves=t.halfmoves,this.fullmoves=t.fullmoves}kingAttackers(t,i,n){return _n(t,i,this.board,n)}playCaptureAt(t,i){this.halfmoves=0,i.role==="rook"&&this.castles.discardRook(t),this.pockets&&this.pockets[R(i.color)][i.promoted?"pawn":i.role]++}ctx(){const t=this.isVariantEnd(),i=this.board.kingOf(this.turn);if(!v(i))return{king:i,blockers:h.empty(),checkers:h.empty(),variantEnd:t,mustCapture:!1};const n=Ut(i,h.empty()).intersect(this.board.rooksAndQueens()).union(jt(i,h.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[R(this.turn)]);let r=h.empty();for(const s of n){const a=qt(i,s).intersect(this.board.occupied);a.moreThanOne()||(r=r.union(a))}const o=this.kingAttackers(i,R(this.turn),this.board.occupied);return{king:i,blockers:r,checkers:o,variantEnd:t,mustCapture:!1}}clone(){var t,i;const n=new this.constructor;return n.board=this.board.clone(),n.pockets=(t=this.pockets)===null||t===void 0?void 0:t.clone(),n.turn=this.turn,n.castles=this.castles.clone(),n.epSquare=this.epSquare,n.remainingChecks=(i=this.remainingChecks)===null||i===void 0?void 0:i.clone(),n.halfmoves=this.halfmoves,n.fullmoves=this.fullmoves,n}validate(){if(this.board.occupied.isEmpty())return w.err(new L(B.Empty));if(this.board.king.size()!==2)return w.err(new L(B.Kings));if(!v(this.board.kingOf(this.turn)))return w.err(new L(B.Kings));const t=this.board.kingOf(R(this.turn));return v(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?w.err(new L(B.OppositeCheck)):h.backranks().intersects(this.board.pawn)?w.err(new L(B.PawnsOnBackrank)):w.ok(void 0):w.err(new L(B.Kings))}dropDests(t){return h.empty()}dests(t,i){if(i=i||this.ctx(),i.variantEnd)return h.empty();const n=this.board.get(t);if(!n||n.color!==this.turn)return h.empty();let r,o;if(n.role==="pawn"){r=Lt(this.turn,t).intersect(this.board[R(this.turn)]);const s=this.turn==="white"?8:-8,a=t+s;if(0<=a&&a<64&&!this.board.occupied.has(a)){r=r.with(a);const l=this.turn==="white"?t<16:t>=48,c=a+s;l&&!this.board.occupied.has(c)&&(r=r.with(c))}v(this.epSquare)&&ir(this,t,i)&&(o=h.fromSquare(this.epSquare))}else n.role==="bishop"?r=jt(t,this.board.occupied):n.role==="knight"?r=Ge(t):n.role==="rook"?r=Ut(t,this.board.occupied):n.role==="queen"?r=ji(t,this.board.occupied):r=zt(t);if(r=r.diff(this.board[this.turn]),v(i.king)){if(n.role==="king"){const s=this.board.occupied.without(t);for(const a of r)this.kingAttackers(a,R(this.turn),s).nonEmpty()&&(r=r.without(a));return r.union(re(this,"a",i)).union(re(this,"h",i))}if(i.checkers.nonEmpty()){const s=i.checkers.singleSquare();if(!v(s))return h.empty();r=r.intersect(qt(s,i.king).with(s))}i.blockers.has(t)&&(r=r.intersect(Vi(t,i.king)))}return o&&(r=r.union(o)),r}isVariantEnd(){return!1}variantOutcome(t){}hasInsufficientMaterial(t){return this.board[t].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty()?!1:this.board[t].intersects(this.board.knight)?this.board[t].size()<=2&&this.board[R(t)].diff(this.board.king).diff(this.board.queen).isEmpty():this.board[t].intersects(this.board.bishop)?(!this.board.bishop.intersects(h.darkSquares())||!this.board.bishop.intersects(h.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty():!0}toSetup(){var t,i;return{board:this.board.clone(),pockets:(t=this.pockets)===null||t===void 0?void 0:t.clone(),turn:this.turn,castlingRights:this.castles.castlingRights,epSquare:er(this),remainingChecks:(i=this.remainingChecks)===null||i===void 0?void 0:i.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return tt.every(t=>this.hasInsufficientMaterial(t))}hasDests(t){t=t||this.ctx();for(const i of this.board[this.turn])if(this.dests(i,t).nonEmpty())return!0;return this.dropDests(t).nonEmpty()}isLegal(t,i){if(ee(t))return!this.pockets||this.pockets[this.turn][t.role]<=0||t.role==="pawn"&&h.backranks().has(t.to)?!1:this.dropDests(i).has(t.to);{if(t.promotion==="pawn"||t.promotion==="king"&&this.rules!=="antichess"||!!t.promotion!==(this.board.pawn.has(t.from)&&h.backranks().has(t.to)))return!1;const n=this.dests(t.from,i);return n.has(t.to)||n.has(nr(this,t).to)}}isCheck(){const t=this.board.kingOf(this.turn);return v(t)&&this.kingAttackers(t,R(this.turn),this.board.occupied).nonEmpty()}isEnd(t){return(t?t.variantEnd:this.isVariantEnd())?!0:this.isInsufficientMaterial()||!this.hasDests(t)}isCheckmate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.nonEmpty()&&!this.hasDests(t)}isStalemate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.isEmpty()&&!this.hasDests(t)}outcome(t){return this.variantOutcome(t)||(t=t||this.ctx(),this.isCheckmate(t)?{winner:R(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(t)?{winner:void 0}:void 0)}allDests(t){t=t||this.ctx();const i=new Map;if(t.variantEnd)return i;for(const n of this.board[this.turn])i.set(n,this.dests(n,t));return i}play(t){const i=this.turn,n=this.epSquare,r=Qi(this,t);if(this.epSquare=void 0,this.halfmoves+=1,i==="black"&&(this.fullmoves+=1),this.turn=R(i),ee(t))this.board.set(t.to,{role:t.role,color:i}),this.pockets&&this.pockets[i][t.role]--,t.role==="pawn"&&(this.halfmoves=0);else{const o=this.board.take(t.from);if(!o)return;let s;if(o.role==="pawn"){this.halfmoves=0,t.to===n&&(s=this.board.take(t.to+(i==="white"?-8:8)));const a=t.from-t.to;Math.abs(a)===16&&8<=t.from&&t.from<=55&&(this.epSquare=t.from+t.to>>1),t.promotion&&(o.role=t.promotion,o.promoted=!!this.pockets)}else if(o.role==="rook")this.castles.discardRook(t.from);else if(o.role==="king"){if(r){const a=this.castles.rook[i][r];if(v(a)){const l=this.board.take(a);this.board.set(Qe(i,r),o),l&&this.board.set(We(i,r),l)}}this.castles.discardColor(i)}if(!r){const a=this.board.set(t.to,o)||s;a&&this.playCaptureAt(t.to,a)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[i]=Math.max(this.remainingChecks[i]-1,0))}}class ne extends pt{constructor(){super("chess")}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const i=new this;return i.setupUnchecked(t),i.validate().map(n=>i)}clone(){return super.clone()}}const tr=(e,t)=>{if(!v(t))return;const i=e.turn==="white"?5:2,n=e.turn==="white"?8:-8;if(Gt(t)!==i||e.board.occupied.has(t+n))return;const r=t-n;if(!(!e.board.pawn.has(r)||!e.board[R(e.turn)].has(r)))return t},er=e=>{if(!v(e.epSquare))return;const t=e.ctx(),i=e.board.pieces(e.turn,"pawn").intersect(Lt(R(e.turn),e.epSquare));for(const n of i)if(e.dests(n,t).has(e.epSquare))return e.epSquare},ir=(e,t,i)=>{if(!v(e.epSquare)||!Lt(e.turn,t).has(e.epSquare))return!1;if(!v(i.king))return!0;const n=e.turn==="white"?8:-8,r=e.epSquare-n;return e.kingAttackers(i.king,R(e.turn),e.board.occupied.toggle(t).toggle(r).with(e.epSquare)).without(r).isEmpty()},re=(e,t,i)=>{if(!v(i.king)||i.checkers.nonEmpty())return h.empty();const n=e.castles.rook[e.turn][t];if(!v(n)||e.castles.path[e.turn][t].intersects(e.board.occupied))return h.empty();const r=Qe(e.turn,t),o=qt(i.king,r),s=e.board.occupied.without(i.king);for(const c of o)if(e.kingAttackers(c,R(e.turn),s).nonEmpty())return h.empty();const a=We(e.turn,t),l=e.board.occupied.toggle(i.king).toggle(n).toggle(a);return e.kingAttackers(r,R(e.turn),l).nonEmpty()?h.empty():h.fromSquare(n)},Ne=(e,t,i)=>{if(i.variantEnd)return h.empty();const n=e.board.get(t);if(!n||n.color!==e.turn)return h.empty();let r=Ui(n,t,e.board.occupied);if(n.role==="pawn"){let o=e.board[R(e.turn)];v(e.epSquare)&&(o=o.with(e.epSquare)),r=r.intersect(o);const s=e.turn==="white"?8:-8,a=t+s;if(0<=a&&a<64&&!e.board.occupied.has(a)){r=r.with(a);const l=e.turn==="white"?t<16:t>=48,c=a+s;l&&!e.board.occupied.has(c)&&(r=r.with(c))}return r}else r=r.diff(e.board[e.turn]);return t===i.king?r.union(re(e,"a",i)).union(re(e,"h",i)):r},Qi=(e,t)=>{if(ee(t))return;const i=t.to-t.from;if(!(Math.abs(i)!==2&&!e.board[e.turn].has(t.to))&&e.board.king.has(t.from))return i>0?"h":"a"},nr=(e,t)=>{const i=Qi(e,t);if(!i)return t;const n=e.castles.rook[e.turn][i];return{from:t.from,to:v(n)?n:t.to}};class Z{constructor(){}static empty(){const t=new Z;for(const i of _)t[i]=0;return t}static fromBoard(t,i){const n=new Z;for(const r of _)n[r]=t.pieces(i,r).size();return n}clone(){const t=new Z;for(const i of _)t[i]=this[i];return t}equals(t){return _.every(i=>this[i]===t[i])}add(t){const i=new Z;for(const n of _)i[n]=this[n]+t[n];return i}subtract(t){const i=new Z;for(const n of _)i[n]=this[n]-t[n];return i}nonEmpty(){return _.some(t=>this[t]>0)}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}size(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}class ot{constructor(t,i){this.white=t,this.black=i}static empty(){return new ot(Z.empty(),Z.empty())}static fromBoard(t){return new ot(Z.fromBoard(t,"white"),Z.fromBoard(t,"black"))}clone(){return new ot(this.white.clone(),this.black.clone())}equals(t){return this.white.equals(t.white)&&this.black.equals(t.black)}add(t){return new ot(this.white.add(t.white),this.black.add(t.black))}subtract(t){return new ot(this.white.subtract(t.white),this.black.subtract(t.black))}count(t){return this.white[t]+this.black[t]}size(){return this.white.size()+this.black.size()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}class vt{constructor(t,i){this.white=t,this.black=i}static default(){return new vt(3,3)}clone(){return new vt(this.white,this.black)}equals(t){return this.white===t.white&&this.black===t.black}}const rr=()=>({board:ht.default(),pockets:void 0,turn:"white",castlingRights:h.corners(),epSquare:void 0,remainingChecks:void 0,halfmoves:0,fullmoves:1});var D;(function(e){e.Fen="ERR_FEN",e.Board="ERR_BOARD",e.Pockets="ERR_POCKETS",e.Turn="ERR_TURN",e.Castling="ERR_CASTLING",e.EpSquare="ERR_EP_SQUARE",e.RemainingChecks="ERR_REMAINING_CHECKS",e.Halfmoves="ERR_HALFMOVES",e.Fullmoves="ERR_FULLMOVES"})(D||(D={}));class $ extends Error{}const or=(e,t,i)=>{let n=e.indexOf(t);for(;i-- >0&&n!==-1;)n=e.indexOf(t,n+t.length);return n},St=e=>/^\d{1,4}$/.test(e)?parseInt(e,10):void 0,Wi=e=>{const t=Ot(e);return t&&{role:t,color:e.toLowerCase()===e?"black":"white"}},ke=e=>{const t=ht.empty();let i=7,n=0;for(let r=0;r<e.length;r++){const o=e[r];if(o==="/"&&n===8)n=0,i--;else{const s=parseInt(o,10);if(s>0)n+=s;else{if(n>=8||i<0)return w.err(new $(D.Board));const a=n+i*8,l=Wi(o);if(!l)return w.err(new $(D.Board));e[r+1]==="~"&&(l.promoted=!0,r++),t.set(a,l),n++}}}return i!==0||n!==8?w.err(new $(D.Board)):w.ok(t)},ui=e=>{if(e.length>64)return w.err(new $(D.Pockets));const t=ot.empty();for(const i of e){const n=Wi(i);if(!n)return w.err(new $(D.Pockets));t[n.color][n.role]++}return w.ok(t)},sr=(e,t)=>{let i=h.empty();if(t==="-")return w.ok(i);for(const n of t){const r=n.toLowerCase(),o=n===r?"black":"white",s=o==="white"?0:7;if("a"<=r&&r<="h")i=i.with(Oe(r.charCodeAt(0)-97,s));else if(r==="k"||r==="q"){const a=e[o].intersect(h.backrank(o)).intersect(e.rook.union(e.king)),l=r==="k"?a.last():a.first();i=i.with(v(l)&&e.rook.has(l)?l:Oe(r==="k"?7:0,s))}else return w.err(new $(D.Castling))}return tt.some(n=>h.backrank(n).intersect(i).size()>2)?w.err(new $(D.Castling)):w.ok(i)},di=e=>{const t=e.split("+");if(t.length===3&&t[0]===""){const i=St(t[1]),n=St(t[2]);return!v(i)||i>3||!v(n)||n>3?w.err(new $(D.RemainingChecks)):w.ok(new vt(3-i,3-n))}else if(t.length===2){const i=St(t[0]),n=St(t[1]);return!v(i)||i>3||!v(n)||n>3?w.err(new $(D.RemainingChecks)):w.ok(new vt(i,n))}else return w.err(new $(D.RemainingChecks))},Gi=e=>{const t=e.split(/[\s_]+/),i=t.shift();let n,r=w.ok(void 0);if(i.endsWith("]")){const a=i.indexOf("[");if(a===-1)return w.err(new $(D.Fen));n=ke(i.slice(0,a)),r=ui(i.slice(a+1,-1))}else{const a=or(i,"/",7);a===-1?n=ke(i):(n=ke(i.slice(0,a)),r=ui(i.slice(a+1)))}let o;const s=t.shift();if(!v(s)||s==="w")o="white";else if(s==="b")o="black";else return w.err(new $(D.Turn));return n.chain(a=>{const l=t.shift(),c=v(l)?sr(a,l):w.ok(h.empty()),p=t.shift();let m;if(v(p)&&p!=="-"&&(m=ct(p),!v(m)))return w.err(new $(D.EpSquare));let P=t.shift(),k;v(P)&&P.includes("+")&&(k=di(P),P=t.shift());const u=v(P)?St(P):0;if(!v(u))return w.err(new $(D.Halfmoves));const f=t.shift(),g=v(f)?St(f):1;if(!v(g))return w.err(new $(D.Fullmoves));const C=t.shift();let y=w.ok(void 0);if(v(C)){if(v(k))return w.err(new $(D.RemainingChecks));y=di(C)}else v(k)&&(y=k);return t.length>0?w.err(new $(D.Fen)):r.chain(O=>c.chain(M=>y.map(E=>({board:a,pockets:O,turn:o,castlingRights:M,remainingChecks:E,epSquare:m,halfmoves:u,fullmoves:Math.max(1,g)}))))})},ar=e=>{let t=Hi(e.role);return e.color==="white"&&(t=t.toUpperCase()),e.promoted&&(t+="~"),t},cr=e=>{let t="",i=0;for(let n=7;n>=0;n--)for(let r=0;r<8;r++){const o=r+n*8,s=e.get(o);s?(i>0&&(t+=i,i=0),t+=ar(s)):i++,r===7&&(i>0&&(t+=i,i=0),n!==0&&(t+="/"))}return t},fi=e=>_.map(t=>Hi(t).repeat(e[t])).join(""),hr=e=>fi(e.white).toUpperCase()+fi(e.black),lr=(e,t)=>{let i="";for(const n of tt){const r=h.backrank(n);let o=e.kingOf(n);v(o)&&!r.has(o)&&(o=void 0);const s=e.pieces(n,"rook").intersect(r);for(const a of t.intersect(r).reversed())if(a===s.first()&&v(o)&&a<o)i+=n==="white"?"Q":"q";else if(a===s.last()&&v(o)&&o<a)i+=n==="white"?"K":"k";else{const l=$i[it(a)];i+=n==="white"?l.toUpperCase():l}}return i||"-"},ur=e=>`${e.white}+${e.black}`,dr=(e,t)=>[cr(e.board)+(e.pockets?`[${hr(e.pockets)}]`:""),e.turn[0],lr(e.board,e.castlingRights),v(e.epSquare)?At(e.epSquare):"-",...e.remainingChecks?[ur(e.remainingChecks)]:[],Math.max(0,Math.min(e.halfmoves,9999)),Math.max(1,Math.min(e.fullmoves,9999))].join(" "),fr=(e,t)=>{const i=new Map,n=e.ctx();for(const[r,o]of e.allDests(n))if(o.nonEmpty()){const s=Array.from(o,At);r===n.king&&it(r)===4&&(o.has(0)?s.push("c1"):o.has(56)&&s.push("c8"),o.has(7)?s.push("g1"):o.has(63)&&s.push("g8")),i.set(At(r),s)}return i},pi=e=>ee(e)?[At(e.to)]:[At(e.from),At(e.to)],pr=(e,t)=>{const i=e.ctx(),n=t.match(/^([NBRQK])?([a-h])?([1-8])?[-x]?([a-h][1-8])(?:=?([nbrqkNBRQK]))?[+#]?$/);if(!n){let p;if(t==="O-O"||t==="O-O+"||t==="O-O#"?p="h":(t==="O-O-O"||t==="O-O-O+"||t==="O-O-O#")&&(p="a"),p){const k=e.castles.rook[e.turn][p];return!v(i.king)||!v(k)||!e.dests(i.king,i).has(k)?void 0:{from:i.king,to:k}}const m=t.match(/^([pnbrqkPNBRQK])?@([a-h][1-8])[+#]?$/);if(!m)return;const P={role:m[1]?Ot(m[1]):"pawn",to:ct(m[2])};return e.isLegal(P,i)?P:void 0}const r=n[1]?Ot(n[1]):"pawn",o=ct(n[4]),s=n[5]?Ot(n[5]):void 0;if(!!s!==(r==="pawn"&&h.backranks().has(o))||s==="king"&&e.rules!=="antichess")return;let a=e.board.pieces(e.turn,r);r==="pawn"&&!n[2]?a=a.intersect(h.fromFile(it(o))):n[2]&&(a=a.intersect(h.fromFile(n[2].charCodeAt(0)-97))),n[3]&&(a=a.intersect(h.fromRank(n[3].charCodeAt(0)-49)));const l=r==="pawn"?h.fromFile(it(o)):h.empty();a=a.intersect(l.union(Ui({color:R(e.turn),role:r},o,e.board.occupied)));let c;for(const p of a)if(e.dests(p,i).has(o)){if(v(c))return;c=p}if(v(c))return{from:c,to:o,promotion:s}};class Zi extends pt{constructor(){super("crazyhouse")}reset(){super.reset(),this.pockets=ot.empty()}setupUnchecked(t){super.setupUnchecked(t),this.board.promoted=t.board.promoted.intersect(t.board.occupied).diff(t.board.king).diff(t.board.pawn),this.pockets=t.pockets?t.pockets.clone():ot.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const i=new this;return i.setupUnchecked(t),i.validate().map(n=>i)}clone(){return super.clone()}validate(){return super.validate().chain(t=>{var i,n;return!((i=this.pockets)===null||i===void 0)&&i.count("king")?w.err(new L(B.Kings)):(((n=this.pockets)===null||n===void 0?void 0:n.size())||0)+this.board.occupied.size()>64?w.err(new L(B.Variant)):w.ok(void 0)})}hasInsufficientMaterial(t){return this.pockets?this.board.occupied.size()+this.pockets.size()<=3&&this.board.pawn.isEmpty()&&this.board.promoted.isEmpty()&&this.board.rooksAndQueens().isEmpty()&&this.pockets.count("pawn")<=0&&this.pockets.count("rook")<=0&&this.pockets.count("queen")<=0:super.hasInsufficientMaterial(t)}dropDests(t){var i,n;const r=this.board.occupied.complement().intersect(!((i=this.pockets)===null||i===void 0)&&i[this.turn].hasNonPawns()?h.full():!((n=this.pockets)===null||n===void 0)&&n[this.turn].hasPawns()?h.backranks().complement():h.empty());if(t=t||this.ctx(),v(t.king)&&t.checkers.nonEmpty()){const o=t.checkers.singleSquare();return v(o)?r.intersect(qt(o,t.king)):h.empty()}else return r}}class Yi extends pt{constructor(){super("atomic")}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const i=new this;return i.setupUnchecked(t),i.validate().map(n=>i)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return w.err(new L(B.Empty));if(this.board.king.size()>2)return w.err(new L(B.Kings));const t=this.board.kingOf(R(this.turn));return v(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?w.err(new L(B.OppositeCheck)):h.backranks().intersects(this.board.pawn)?w.err(new L(B.PawnsOnBackrank)):w.ok(void 0):w.err(new L(B.Kings))}kingAttackers(t,i,n){const r=this.board.pieces(i,"king");return r.isEmpty()||zt(t).intersects(r)?h.empty():super.kingAttackers(t,i,n)}playCaptureAt(t,i){super.playCaptureAt(t,i),this.board.take(t);for(const n of zt(t).intersect(this.board.occupied).diff(this.board.pawn)){const r=this.board.take(n);r?.role==="rook"&&this.castles.discardRook(n),r?.role==="king"&&this.castles.discardColor(r.color)}}hasInsufficientMaterial(t){if(this.board.pieces(R(t),"king").isEmpty())return!1;if(this.board[t].diff(this.board.king).isEmpty())return!0;if(this.board[R(t)].diff(this.board.king).nonEmpty()){if(this.board.occupied.equals(this.board.bishop.union(this.board.king))){if(!this.board.bishop.intersect(this.board.white).intersects(h.darkSquares()))return!this.board.bishop.intersect(this.board.black).intersects(h.lightSquares());if(!this.board.bishop.intersect(this.board.white).intersects(h.lightSquares()))return!this.board.bishop.intersect(this.board.black).intersects(h.darkSquares())}return!1}return this.board.queen.nonEmpty()||this.board.pawn.nonEmpty()?!1:this.board.knight.union(this.board.bishop).union(this.board.rook).size()===1?!0:this.board.occupied.equals(this.board.knight.union(this.board.king))?this.board.knight.size()<=2:!1}dests(t,i){i=i||this.ctx();let n=h.empty();for(const r of Ne(this,t,i)){const o=this.clone();o.play({from:t,to:r});const s=o.board.kingOf(this.turn);v(s)&&(!v(o.board.kingOf(o.turn))||o.kingAttackers(s,o.turn,o.board.occupied).isEmpty())&&(n=n.with(r))}return n}isVariantEnd(){return!!this.variantOutcome()}variantOutcome(t){for(const i of tt)if(this.board.pieces(i,"king").isEmpty())return{winner:R(i)}}}class Xi extends pt{constructor(){super("antichess")}reset(){super.reset(),this.castles=Y.empty()}setupUnchecked(t){super.setupUnchecked(t),this.castles=Y.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const i=new this;return i.setupUnchecked(t),i.validate().map(n=>i)}clone(){return super.clone()}validate(){return this.board.occupied.isEmpty()?w.err(new L(B.Empty)):h.backranks().intersects(this.board.pawn)?w.err(new L(B.PawnsOnBackrank)):w.ok(void 0)}kingAttackers(t,i,n){return h.empty()}ctx(){const t=super.ctx();if(v(this.epSquare)&&Lt(R(this.turn),this.epSquare).intersects(this.board.pieces(this.turn,"pawn")))return t.mustCapture=!0,t;const i=this.board[R(this.turn)];for(const n of this.board[this.turn])if(Ne(this,n,t).intersects(i))return t.mustCapture=!0,t;return t}dests(t,i){i=i||this.ctx();const n=Ne(this,t,i),r=this.board[R(this.turn)];return n.intersect(i.mustCapture?v(this.epSquare)&&this.board.getRole(t)==="pawn"?r.with(this.epSquare):r:h.full())}hasInsufficientMaterial(t){if(this.board[t].isEmpty())return!1;if(this.board[R(t)].isEmpty())return!0;if(this.board.occupied.equals(this.board.bishop)){const i=this.board[t].intersects(h.lightSquares()),n=this.board[t].intersects(h.darkSquares()),r=this.board[R(t)].isDisjoint(h.lightSquares()),o=this.board[R(t)].isDisjoint(h.darkSquares());return i&&r||n&&o}return this.board.occupied.equals(this.board.knight)&&this.board.occupied.size()===2?this.board.white.intersects(h.lightSquares())!==this.board.black.intersects(h.darkSquares())!=(this.turn===t):!1}isVariantEnd(){return this.board[this.turn].isEmpty()}variantOutcome(t){if(t=t||this.ctx(),t.variantEnd||this.isStalemate(t))return{winner:this.turn}}}class Ji extends pt{constructor(){super("kingofthehill")}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const i=new this;return i.setupUnchecked(t),i.validate().map(n=>i)}clone(){return super.clone()}hasInsufficientMaterial(t){return!1}isVariantEnd(){return this.board.king.intersects(h.center())}variantOutcome(t){for(const i of tt)if(this.board.pieces(i,"king").intersects(h.center()))return{winner:i}}}class _i extends pt{constructor(){super("3check")}reset(){super.reset(),this.remainingChecks=vt.default()}setupUnchecked(t){var i;super.setupUnchecked(t),this.remainingChecks=((i=t.remainingChecks)===null||i===void 0?void 0:i.clone())||vt.default()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const i=new this;return i.setupUnchecked(t),i.validate().map(n=>i)}clone(){return super.clone()}hasInsufficientMaterial(t){return this.board.pieces(t,"king").equals(this.board[t])}isVariantEnd(){return!!this.remainingChecks&&(this.remainingChecks.white<=0||this.remainingChecks.black<=0)}variantOutcome(t){if(this.remainingChecks){for(const i of tt)if(this.remainingChecks[i]<=0)return{winner:i}}}}const mr=()=>{const e=ht.empty();return e.occupied=new h(65535,0),e.promoted=h.empty(),e.white=new h(61680,0),e.black=new h(3855,0),e.pawn=h.empty(),e.knight=new h(6168,0),e.bishop=new h(9252,0),e.rook=new h(16962,0),e.queen=new h(129,0),e.king=new h(33024,0),e};class tn extends pt{constructor(){super("racingkings")}reset(){this.board=mr(),this.pockets=void 0,this.turn="white",this.castles=Y.empty(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){super.setupUnchecked(t),this.castles=Y.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const i=new this;return i.setupUnchecked(t),i.validate().map(n=>i)}clone(){return super.clone()}validate(){return this.isCheck()||this.board.pawn.nonEmpty()?w.err(new L(B.Variant)):super.validate()}dests(t,i){if(i=i||this.ctx(),t===i.king)return super.dests(t,i);let n=h.empty();for(const r of super.dests(t,i)){const o={from:t,to:r},s=this.clone();s.play(o),s.isCheck()||(n=n.with(r))}return n}hasInsufficientMaterial(t){return!1}isVariantEnd(){const t=h.fromRank(7),i=this.board.king.intersect(t);if(i.isEmpty())return!1;if(this.turn==="white"||i.intersects(this.board.black))return!0;const n=this.board.kingOf("black");if(v(n)){const r=this.board.occupied.without(n);for(const o of zt(n).intersect(t).diff(this.board.black))if(this.kingAttackers(o,"white",r).isEmpty())return!1}return!0}variantOutcome(t){if(t?!t.variantEnd:!this.isVariantEnd())return;const i=h.fromRank(7),n=this.board.pieces("black","king").intersects(i),r=this.board.pieces("white","king").intersects(i);return n&&!r?{winner:"black"}:r&&!n?{winner:"white"}:{winner:void 0}}}const gr=()=>{const e=ht.empty();return e.occupied=new h(4294967295,4294901862),e.promoted=h.empty(),e.white=new h(4294967295,102),e.black=new h(0,4294901760),e.pawn=new h(4294967295,16711782),e.knight=new h(0,1107296256),e.bishop=new h(0,603979776),e.rook=new h(0,2164260864),e.queen=new h(0,134217728),e.king=new h(0,268435456),e};class en extends pt{constructor(){super("horde")}reset(){this.board=gr(),this.pockets=void 0,this.turn="white",this.castles=Y.default(),this.castles.discardColor("white"),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const i=new this;return i.setupUnchecked(t),i.validate().map(n=>i)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return w.err(new L(B.Empty));if(this.board.king.size()!==1)return w.err(new L(B.Kings));const t=this.board.kingOf(R(this.turn));if(v(t)&&this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty())return w.err(new L(B.OppositeCheck));for(const i of tt){const n=this.board.pieces(i,"king").isEmpty()?h.backrank(R(i)):h.backranks();if(this.board.pieces(i,"pawn").intersects(n))return w.err(new L(B.PawnsOnBackrank))}return w.ok(void 0)}hasInsufficientMaterial(t){if(this.board.pieces(t,"king").nonEmpty())return!1;const i=k=>k==="light"?"dark":"light",n=k=>k==="light"?h.lightSquares():h.darkSquares(),r=k=>{const u=this.board.pieces(k,"bishop");return u.intersects(h.darkSquares())&&u.intersects(h.lightSquares())},o=Z.fromBoard(this.board,t),s=k=>n(k).intersect(this.board.pieces(t,"bishop")).size(),a=s("light")>=1?"light":"dark",l=o.pawn+o.knight+o.rook+o.queen+Math.min(s("dark"),2)+Math.min(s("light"),2),c=Z.fromBoard(this.board,R(t)),p=k=>n(k).intersect(this.board.pieces(R(t),"bishop")).size(),m=c.size(),P=k=>m-k;if(l===0)return!0;if(l>=4||(o.pawn>=1||o.queen>=1)&&l>=2||o.rook>=1&&l>=2&&!(l===2&&o.rook===1&&o.bishop===1&&P(p(a))===1))return!1;if(l===1){if(m===1)return!0;if(o.queen===1)return!(c.pawn>=1||c.rook>=1||p("light")>=2||p("dark")>=2);if(o.pawn===1){const k=this.board.pieces(t,"pawn").last(),u=this.clone();u.board.set(k,{color:t,role:"queen"});const f=this.clone();return f.board.set(k,{color:t,role:"knight"}),u.hasInsufficientMaterial(t)&&f.hasInsufficientMaterial(t)}else{if(o.rook===1)return!(c.pawn>=2||c.rook>=1&&c.pawn>=1||c.rook>=1&&c.knight>=1||c.pawn>=1&&c.knight>=1);if(o.bishop===1)return!(p(i(a))>=2||p(i(a))>=1&&c.pawn>=1||c.pawn>=2);if(o.knight===1)return!(m>=4&&(c.knight>=2||c.pawn>=2||c.rook>=1&&c.knight>=1||c.rook>=1&&c.bishop>=1||c.knight>=1&&c.bishop>=1||c.rook>=1&&c.pawn>=1||c.knight>=1&&c.pawn>=1||c.bishop>=1&&c.pawn>=1||r(R(t))&&c.pawn>=1)&&(p("dark")<2||P(p("dark"))>=3)&&(p("light")<2||P(p("light"))>=3))}}else{if(l===2)return m===1?!0:o.knight===2?c.pawn+c.bishop+c.knight<1:r(t)?!(c.pawn>=1||c.bishop>=1||c.knight>=1&&c.rook+c.queen>=1):o.bishop>=1&&o.knight>=1?!(c.pawn>=1||p(i(a))>=1||P(p(a))>=3):!(c.pawn>=1&&p(i(a))>=1||c.pawn>=1&&c.knight>=1||p(i(a))>=1&&c.knight>=1||p(i(a))>=2||c.knight>=2||c.pawn>=2);if(l===3)return o.knight===2&&o.bishop===1||o.knight===3||r(t)?!1:m===1}return!0}isVariantEnd(){return this.board.white.isEmpty()||this.board.black.isEmpty()}variantOutcome(t){if(this.board.white.isEmpty())return{winner:"black"};if(this.board.black.isEmpty())return{winner:"white"}}}const kr=e=>{switch(e){case"chess":return ne.default();case"antichess":return Xi.default();case"atomic":return Yi.default();case"horde":return en.default();case"racingkings":return tn.default();case"kingofthehill":return Ji.default();case"3check":return _i.default();case"crazyhouse":return Zi.default()}},wr=(e,t)=>{switch(e){case"chess":return ne.fromSetup(t);case"antichess":return Xi.fromSetup(t);case"atomic":return Yi.fromSetup(t);case"horde":return en.fromSetup(t);case"racingkings":return tn.fromSetup(t);case"kingofthehill":return Ji.fromSetup(t);case"3check":return _i.fromSetup(t);case"crazyhouse":return Zi.fromSetup(t)}},br=(e=Ze)=>({headers:e(),moves:new nn});class nn{constructor(){this.children=[]}*mainlineNodes(){let t=this;for(;t.children.length;){const i=t.children[0];yield i,t=i}}*mainline(){for(const t of this.mainlineNodes())yield t.data}end(){let t=this;for(;t.children.length;)t=t.children[0];return t}}class vr extends nn{constructor(t){super(),this.data=t}}const yr=e=>e?e.winner==="white"?"1-0":e.winner==="black"?"0-1":"1/2-1/2":"*",Cr=e=>e==="1-0"||e==="1–0"||e==="1—0"?{winner:"white"}:e==="0-1"||e==="0–1"||e==="0—1"?{winner:"black"}:e==="1/2-1/2"||e==="1/2–1/2"||e==="1/2—1/2"?{winner:void 0}:void 0,Ze=()=>new Map([["Event","?"],["Site","?"],["Date","????.??.??"],["Round","?"],["White","?"],["Black","?"],["Result","*"]]),mi="\uFEFF",we=e=>/^\s*$/.test(e),be=e=>e.startsWith("%");class Er extends Error{}class Mr{constructor(t,i=Ze,n=1e6){this.emitGame=t,this.initHeaders=i,this.maxBudget=n,this.lineBuf=[],this.resetGame(),this.state=0}resetGame(){this.budget=this.maxBudget,this.found=!1,this.state=1,this.game=br(this.initHeaders),this.stack=[{parent:this.game.moves,root:!0}],this.commentBuf=[]}consumeBudget(t){if(this.budget-=t,this.budget<0)throw new Er("ERR_PGN_BUDGET")}parse(t,i){if(!(this.budget<0))try{let n=0;for(;;){const r=t.indexOf(`
`,n);if(r===-1)break;const o=r>n&&t[r-1]==="\r"?r-1:r;this.consumeBudget(r-n),this.lineBuf.push(t.slice(n,o)),n=r+1,this.handleLine()}this.consumeBudget(t.length-n),this.lineBuf.push(t.slice(n)),i!=null&&i.stream||(this.handleLine(),this.emit(void 0))}catch(n){this.emit(n)}}handleLine(){let t=!0,i=this.lineBuf.join("");this.lineBuf=[];t:for(;;)switch(this.state){case 0:i.startsWith(mi)&&(i=i.slice(mi.length)),this.state=1;case 1:if(we(i)||be(i))return;this.found=!0,this.state=2;case 2:{if(be(i))return;let n=!0;for(;n;)n=!1,i=i.replace(/^\s*\[([A-Za-z0-9][A-Za-z0-9_+#=:-]*)\s+"((?:[^"\\]|\\"|\\\\)*)"\]/,(r,o,s)=>(this.consumeBudget(200),this.handleHeader(o,s.replace(/\\"/g,'"').replace(/\\\\/g,"\\")),n=!0,t=!1,""));if(we(i))return;this.state=3}case 3:{if(t){if(be(i))return;if(we(i))return this.emit(void 0)}const n=/(?:[NBKRQ]?[a-h]?[1-8]?[-x]?[a-h][1-8](?:=?[nbrqkNBRQK])?|[pnbrqkPNBRQK]?@[a-h][1-8]|[O0o][-–—][O0o](?:[-–—][O0o])?)[+#]?|--|Z0|0000|@@@@|{|;|\$\d{1,4}|[?!]{1,2}|\(|\)|\*|1[-–—]0|0[-–—]1|1\/2[-–—]1\/2/g;let r;for(;r=n.exec(i);){const o=this.stack[this.stack.length-1];let s=r[0];if(s===";")return;if(s.startsWith("$"))this.handleNag(parseInt(s.slice(1),10));else if(s==="!")this.handleNag(1);else if(s==="?")this.handleNag(2);else if(s==="!!")this.handleNag(3);else if(s==="??")this.handleNag(4);else if(s==="!?")this.handleNag(5);else if(s==="?!")this.handleNag(6);else if(s==="1-0"||s==="1–0"||s==="1—0"||s==="0-1"||s==="0–1"||s==="0—1"||s==="1/2-1/2"||s==="1/2–1/2"||s==="1/2—1/2"||s==="*")this.stack.length===1&&s!=="*"&&this.handleHeader("Result",s);else if(s==="(")this.consumeBudget(100),this.stack.push({parent:o.parent,root:!1});else if(s===")")this.stack.length>1&&this.stack.pop();else if(s==="{"){const a=n.lastIndex,l=i[a]===" "?a+1:a;i=i.slice(l),this.state=4;continue t}else this.consumeBudget(100),s.startsWith("O")||s.startsWith("0")||s.startsWith("o")?s=s.replace(/[0o]/g,"O").replace(/[–—]/g,"-"):(s==="Z0"||s==="0000"||s==="@@@@")&&(s="--"),o.node&&(o.parent=o.node),o.node=new vr({san:s,startingComments:o.startingComments}),o.startingComments=void 0,o.root=!1,o.parent.children.push(o.node)}return}case 4:{const n=i.indexOf("}");if(n===-1){this.commentBuf.push(i);return}else{const r=n>0&&i[n-1]===" "?n-1:n;this.commentBuf.push(i.slice(0,r)),this.handleComment(),i=i.slice(n),this.state=3,t=!1}}}}handleHeader(t,i){this.game.headers.set(t,t==="Result"?yr(Cr(i)):i)}handleNag(t){var i;this.consumeBudget(50);const n=this.stack[this.stack.length-1];n.node&&((i=n.node.data).nags||(i.nags=[]),n.node.data.nags.push(t))}handleComment(){var t,i;this.consumeBudget(100);const n=this.stack[this.stack.length-1],r=this.commentBuf.join(`
`);this.commentBuf=[],n.node?((t=n.node.data).comments||(t.comments=[]),n.node.data.comments.push(r)):n.root?((i=this.game).comments||(i.comments=[]),this.game.comments.push(r)):(n.startingComments||(n.startingComments=[]),n.startingComments.push(r))}emit(t){if(this.state===4&&this.handleComment(),t)return this.emitGame(this.game,t);this.found&&this.emitGame(this.game,void 0),this.resetGame()}}const Pr=(e,t=Ze)=>{const i=[];return new Mr(n=>i.push(n),t,NaN).parse(e),i},Sr=e=>{switch((e||"chess").toLowerCase()){case"chess":case"chess960":case"chess 960":case"standard":case"from position":case"classical":case"normal":case"fischerandom":case"fischerrandom":case"fischer random":case"wild/0":case"wild/1":case"wild/2":case"wild/3":case"wild/4":case"wild/5":case"wild/6":case"wild/7":case"wild/8":case"wild/8a":return"chess";case"crazyhouse":case"crazy house":case"house":case"zh":return"crazyhouse";case"king of the hill":case"koth":case"kingofthehill":return"kingofthehill";case"three-check":case"three check":case"threecheck":case"three check chess":case"3-check":case"3 check":case"3check":return"3check";case"antichess":case"anti chess":case"anti":return"antichess";case"atomic":case"atom":case"atomic chess":return"atomic";case"horde":case"horde chess":return"horde";case"racing kings":case"racingkings":case"racing":case"race":return"racingkings";default:return}},Or=e=>{const t=Sr(e.get("Variant"));if(!t)return w.err(new L(B.Variant));const i=e.get("FEN");return i?Gi(i).chain(n=>wr(t,n)):w.ok(kr(t))};class Ar{constructor(t){rt(this,"_promotion"),rt(this,"_isPromotionOpen",!1),this.redraw=t}get promotion(){return this._promotion}set promotion(t){this._promotion=t}isOpen(){return this._isPromotionOpen}close(){this._isPromotionOpen=!1}async open(t,i,n){const r=await new Promise(o=>{this.promotion={dest:t,orig:i,color:n,resolve:o},this._isPromotionOpen=!0,this.redraw()});return this.close(),this.promotion=void 0,this.redraw(),r}applyPromotion(t,i,n,r,o){"promotion"in r&&(r.promotion=n,i.role=n,i.promoted=!0,o.setPieces(new Map([[t,i]])))}isPromotion(t,i){return i.role==="pawn"&&(i.color==="white"&&t[1]==="8"||i.color==="black"&&t[1]==="1")}}class Rr{constructor(t,i,n){rt(this,"ground"),rt(this,"pos"),rt(this,"promotionHandler"),rt(this,"puzzleMainMoves"),rt(this,"currentPuzzleMove",0),rt(this,"initialColorToPlay"),rt(this,"firstAutoMove",!1),this.isFirstMoveBlunder=i,this.redraw=n,this.promotionHandler=new Ar(n);const r=this.getGameFromPgn(t);this.puzzleMainMoves=this.getPuzzleMoves(r),this.pos=this.getInitialPosition(r),this.initialColorToPlay=i?R(this.pos.turn):this.pos.turn,this.firstAutoMove=i}setGround(t){this.ground=t,this.setBoardToPosition(!0),this.firstAutoMove&&(this.firstAutoMove=!1,setTimeout(()=>{this.makeOpponentMove()},400))}cgState(){return{orientation:this.initialColorToPlay,movable:{free:!1,events:{after:(t,i,n)=>this.handleMove(t,i)}}}}isPromotionPromptOpened(){return this.promotionHandler.isOpen()}resolvePromotion(t){if(this.isPromotionPromptOpened()){const i={from:ct(this.promotionHandler.promotion.orig),to:ct(this.promotionHandler.promotion.dest),promotion:t};return this.isPuzzleMove(i)?(this.makeMove(i),this.currentPuzzleMove++,this.makeOpponentMove()):this.handleBlunderMove(this.promotionHandler.promotion.dest),this.promotionHandler.promotion.resolve(t)}else throw new Error("Trying to resolve promotion when promotion prompt is not opened")}cancelPromotion(){if(this.isPromotionPromptOpened())return this.promotionHandler.promotion.resolve(null);throw new Error("Trying to resolve promotion when promotion prompt is not opened")}getPromotionDest(){if(this.isPromotionPromptOpened())return this.promotionHandler.promotion.dest;throw new Error("Trying to get promotion dest when promotion prompt is not opened")}getPromotionColor(){if(this.isPromotionPromptOpened())return this.promotionHandler.promotion.color;throw new Error("Trying to get promotion color when promotion prompt is not opened")}getGameFromPgn(t){const i=Pr(t);if(i.length>1)throw new Error("Only PGNs with a single game are supported");return i[0]}getPuzzleMoves(t){const i=Or(t.headers).unwrap();let n=[];for(const r of t.moves.mainline()){const o=pr(i,r.san);if(!o)throw new Error(`Invalid move in pgn: ${r.san}`);i.play(o),n.push(o)}return n}getInitialPosition(t){const i=t.headers.get("FEN");let n;if(!i)n=ne.fromSetup(rr()).unwrap();else{const r=Gi(i).unwrap();n=ne.fromSetup(r).unwrap()}return n}isPuzzleMove(t){const i=this.puzzleMainMoves[this.currentPuzzleMove];return t.from==i.from&&t.to==i.to&&t.promotion==i.promotion}makeOpponentMove(){if(this.currentPuzzleMove>=this.puzzleMainMoves.length-1){this.endPuzzle();return}setTimeout(()=>{var t;const i=this.puzzleMainMoves[this.currentPuzzleMove],n=pi(i);(t=this.ground)==null||t.move(n[0],n[1]),this.handleMove(n[0],n[1],!0,i.promotion),this.currentPuzzleMove++,this.currentPuzzleMove>=this.puzzleMainMoves.length&&this.endPuzzle()},300)}handleMove(t,i,n=!1,r){const o=`${t}${i}`,s=Wn(o);if(!s)return;const a=this.ground.state.pieces.get(i);if(a){if(this.promotionHandler.isPromotion(i,a))if(n)this.promotionHandler.applyPromotion(i,a,r,s,this.ground);else{this.openPromotionPrompt(i,t,a,s);return}if(this.handleEnPassant(t,i),n)this.makeMove(s,n);else{if(this.currentPuzzleMove>=this.puzzleMainMoves.length)return;this.isPuzzleMove(s)?(this.makeMove(s,n),this.currentPuzzleMove++,this.makeOpponentMove()):this.handleBlunderMove(i)}}}handleBlunderMove(t){var i;(i=this.ground)==null||i.setAutoShapes([{orig:t,customSvg:{html:ki["✗"]}}]),setTimeout(()=>{this.setBoardToPosition(!0)},300)}async openPromotionPrompt(t,i,n,r){const o=await this.promotionHandler.open(t,i,n.color);o?this.promotionHandler.applyPromotion(t,n,o,r,this.ground):this.setBoardToPosition()}handleEnPassant(t,i){const n=this.getEnPassantCaptureSquare(t,i,r=>this.pos.board.get(ct(r)));n&&this.ground.setPieces(new Map([[n,void 0]]))}getEnPassantCaptureSquare(t,i,n){const r=n(t);if(!r||r.role!=="pawn")return;const o=t.charCodeAt(0),s=i.charCodeAt(0);if(Math.abs(o-s)===1&&!n(i)){const a=parseInt(i[1]),l=r.color==="white"?a-1:a+1;return String.fromCharCode(s)+l}}makeMove(t,i=!1){var n,r;this.pos.play(t),this.updateLegalMoves(),i?(r=this.ground)==null||r.setAutoShapes([]):(n=this.ground)==null||n.setAutoShapes([{orig:pi(t)[1],customSvg:{html:ki["✓"]}}])}setBoardToPosition(t=!1){var i;t&&this.ground.set({animation:{enabled:!1}}),this.ground.set({fen:dr(this.pos.toSetup())}),this.updateLegalMoves(),(i=this.ground)==null||i.setAutoShapes([]),t&&this.ground.set({animation:{enabled:!0}})}updateLegalMoves(){this.firstAutoMove||this.ground.set({movable:{dests:fr(this.pos)}})}endPuzzle(){this.ground.set({movable:{dests:void 0}})}}const gi=e=>`<defs><filter id="shadow"><feDropShadow dx="4" dy="7" stdDeviation="5" flood-opacity="0.5" /></filter></defs>
  <g transform="translate(60 0) scale(0.4)">${e}</g>`,ki={"✓":gi(`
  <circle style="fill:#22ac38;filter:url(#shadow)" cx="50" cy="50" r="50" />
  <path fill="#fff" d="M87 32.8q0 2-1.4 3.2L51 70.6 44.6 77q-1.7 1.3-3.4 1.3-1.8 0-3.1-1.3L14.3 53.3Q13 52 13 50q0-2 1.3-3.2l6.4-6.5Q22.4 39 24 39q1.9 0 3.2 1.3l14 14L72.7 23q1.3-1.3 3.2-1.3 1.6 0 3.3 1.3l6.4 6.5q1.3 1.4 1.3 3.4z"/>
`),"✗":gi(`
  <circle style="fill:#df5353;filter:url(#shadow)" cx="50" cy="50" r="50" />
  <path fill="#fff" d="M79.4 68q0 1.8-1.4 3.2l-6.7 6.7q-1.4 1.4-3.5 1.4-1.9 0-3.3-1.4L50 63.4 35.5 78q-1.4 1.4-3.3 1.4-2 0-3.5-1.4L22 71.2q-1.4-1.4-1.4-3.3 0-1.7 1.4-3.5L36.5 50 22 35.4Q20.6 34 20.6 32q0-1.7 1.4-3.5l6.7-6.5q1.2-1.4 3.5-1.4 2 0 3.3 1.4L50 36.6 64.5 22q1.2-1.4 3.3-1.4 2.3 0 3.5 1.4l6.7 6.5q1.4 1.8 1.4 3.5 0 2-1.4 3.3L63.5 49.9 78 64.4q1.4 1.8 1.4 3.5z"/>
`)},xr=["white","black"],oe=["a","b","c","d","e","f","g","h"],se=["1","2","3","4","5","6","7","8"],zr=[...se].reverse(),Ye=Array.prototype.concat(...oe.map(e=>se.map(t=>e+t))),G=e=>Ye[8*e[0]+e[1]],T=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],rn=Ye.map(T);function qr(e){let t;const i=()=>(t===void 0&&(t=e()),t);return i.clear=()=>{t=void 0},i}const Nr=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},Xe=e=>e==="white"?"black":"white",Vt=(e,t)=>{const i=e[0]-t[0],n=e[1]-t[1];return i*i+n*n},Te=(e,t)=>e.role===t.role&&e.color===t.color,Zt=e=>(t,i)=>[(i?t[0]:7-t[0])*e.width/8,(i?7-t[1]:t[1])*e.height/8],et=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},on=(e,t,i=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${i})`},Je=(e,t)=>{e.style.visibility=t?"visible":"hidden"},Et=e=>{var t;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((t=e.targetTouches)===null||t===void 0)&&t[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},sn=e=>e.button===2,st=(e,t)=>{const i=document.createElement(e);return t&&(i.className=t),i};function an(e,t,i){const n=T(e);return t||(n[0]=7-n[0],n[1]=7-n[1]),[i.left+i.width*n[0]/8+i.width/16,i.top+i.height*(7-n[1])/8+i.height/16]}const yt=(e,t)=>Math.abs(e-t),Tr=e=>(t,i,n,r)=>yt(t,n)<2&&(e==="white"?r===i+1||i<=1&&r===i+2&&t===n:r===i-1||i>=6&&r===i-2&&t===n),cn=(e,t,i,n)=>{const r=yt(e,i),o=yt(t,n);return r===1&&o===2||r===2&&o===1},hn=(e,t,i,n)=>yt(e,i)===yt(t,n),ln=(e,t,i,n)=>e===i||t===n,un=(e,t,i,n)=>hn(e,t,i,n)||ln(e,t,i,n),Br=(e,t,i)=>(n,r,o,s)=>yt(n,o)<2&&yt(r,s)<2||i&&r===s&&r===(e==="white"?0:7)&&(n===4&&(o===2&&t.includes(0)||o===6&&t.includes(7))||t.includes(o));function Lr(e,t){const i=t==="white"?"1":"8",n=[];for(const[r,o]of e)r[1]===i&&o.color===t&&o.role==="rook"&&n.push(T(r)[0]);return n}function dn(e,t,i){const n=e.get(t);if(!n)return[];const r=T(t),o=n.role,s=o==="pawn"?Tr(n.color):o==="knight"?cn:o==="bishop"?hn:o==="rook"?ln:o==="queen"?un:Br(n.color,Lr(e,n.color),i);return rn.filter(a=>(r[0]!==a[0]||r[1]!==a[1])&&s(r[0],r[1],a[0],a[1])).map(G)}function Q(e,...t){e&&setTimeout(()=>e(...t),1)}function Kr(e){e.orientation=Xe(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function Dr(e,t){for(const[i,n]of t)n?e.pieces.set(i,n):e.pieces.delete(i)}function Fr(e,t){if(e.check=void 0,t===!0&&(t=e.turnColor),t)for(const[i,n]of e.pieces)n.role==="king"&&n.color===t&&(e.check=i)}function Ir(e,t,i,n){gt(e),e.premovable.current=[t,i],Q(e.premovable.events.set,t,i,n)}function mt(e){e.premovable.current&&(e.premovable.current=void 0,Q(e.premovable.events.unset))}function $r(e,t,i){mt(e),e.predroppable.current={role:t,key:i},Q(e.predroppable.events.set,t,i)}function gt(e){const t=e.predroppable;t.current&&(t.current=void 0,Q(t.events.unset))}function Hr(e,t,i){if(!e.autoCastle)return!1;const n=e.pieces.get(t);if(!n||n.role!=="king")return!1;const r=T(t),o=T(i);if(r[1]!==0&&r[1]!==7||r[1]!==o[1])return!1;r[0]===4&&!e.pieces.has(i)&&(o[0]===6?i=G([7,o[1]]):o[0]===2&&(i=G([0,o[1]])));const s=e.pieces.get(i);return!s||s.color!==n.color||s.role!=="rook"?!1:(e.pieces.delete(t),e.pieces.delete(i),r[0]<o[0]?(e.pieces.set(G([6,o[1]]),n),e.pieces.set(G([5,o[1]]),s)):(e.pieces.set(G([2,o[1]]),n),e.pieces.set(G([3,o[1]]),s)),!0)}function fn(e,t,i){const n=e.pieces.get(t),r=e.pieces.get(i);if(t===i||!n)return!1;const o=r&&r.color!==n.color?r:void 0;return i===e.selected&&X(e),Q(e.events.move,t,i,o),Hr(e,t,i)||(e.pieces.set(i,n),e.pieces.delete(t)),e.lastMove=[t,i],e.check=void 0,Q(e.events.change),o||!0}function _e(e,t,i,n){if(e.pieces.has(i))if(n)e.pieces.delete(i);else return!1;return Q(e.events.dropNewPiece,t,i),e.pieces.set(i,t),e.lastMove=[i],e.check=void 0,Q(e.events.change),e.movable.dests=void 0,e.turnColor=Xe(e.turnColor),!0}function pn(e,t,i){const n=fn(e,t,i);return n&&(e.movable.dests=void 0,e.turnColor=Xe(e.turnColor),e.animation.current=void 0),n}function mn(e,t,i){if(ti(e,t,i)){const n=pn(e,t,i);if(n){const r=e.hold.stop();X(e);const o={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return n!==!0&&(o.captured=n),Q(e.movable.events.after,t,i,o),!0}}else if(Ur(e,t,i))return Ir(e,t,i,{ctrlKey:e.stats.ctrlKey}),X(e),!0;return X(e),!1}function gn(e,t,i,n){const r=e.pieces.get(t);r&&(jr(e,t,i)||n)?(e.pieces.delete(t),_e(e,r,i,n),Q(e.movable.events.afterNewPiece,r.role,i,{premove:!1,predrop:!1})):r&&Vr(e,t,i)?$r(e,r.role,i):(mt(e),gt(e)),e.pieces.delete(t),X(e)}function Be(e,t,i){if(Q(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled){X(e),e.hold.cancel();return}else if((e.selectable.enabled||i)&&e.selected!==t&&mn(e,e.selected,t)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(wn(e,t)||ei(e,t))&&(kn(e,t),e.hold.start())}function kn(e,t){e.selected=t,ei(e,t)?e.premovable.customDests||(e.premovable.dests=dn(e.pieces,t,e.premovable.castle)):e.premovable.dests=void 0}function X(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function wn(e,t){const i=e.pieces.get(t);return!!i&&(e.movable.color==="both"||e.movable.color===i.color&&e.turnColor===i.color)}const ti=(e,t,i)=>{var n,r;return t!==i&&wn(e,t)&&(e.movable.free||!!(!((r=(n=e.movable.dests)===null||n===void 0?void 0:n.get(t))===null||r===void 0)&&r.includes(i)))};function jr(e,t,i){const n=e.pieces.get(t);return!!n&&(t===i||!e.pieces.has(i))&&(e.movable.color==="both"||e.movable.color===n.color&&e.turnColor===n.color)}function ei(e,t){const i=e.pieces.get(t);return!!i&&e.premovable.enabled&&e.movable.color===i.color&&e.turnColor!==i.color}function Ur(e,t,i){var n,r;const o=(r=(n=e.premovable.customDests)===null||n===void 0?void 0:n.get(t))!==null&&r!==void 0?r:dn(e.pieces,t,e.premovable.castle);return t!==i&&ei(e,t)&&o.includes(i)}function Vr(e,t,i){const n=e.pieces.get(t),r=e.pieces.get(i);return!!n&&(!r||r.color!==e.movable.color)&&e.predroppable.enabled&&(n.role!=="pawn"||i[1]!=="1"&&i[1]!=="8")&&e.movable.color===n.color&&e.turnColor!==n.color}function Qr(e,t){const i=e.pieces.get(t);return!!i&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===i.color&&(e.turnColor===i.color||e.premovable.enabled))}function Wr(e){const t=e.premovable.current;if(!t)return!1;const i=t[0],n=t[1];let r=!1;if(ti(e,i,n)){const o=pn(e,i,n);if(o){const s={premove:!0};o!==!0&&(s.captured=o),Q(e.movable.events.after,i,n,s),r=!0}}return mt(e),r}function Gr(e,t){const i=e.predroppable.current;let n=!1;if(!i)return!1;if(t(i)){const r={role:i.role,color:e.movable.color};_e(e,r,i.key)&&(Q(e.movable.events.afterNewPiece,i.role,i.key,{premove:!1,predrop:!0}),n=!0)}return gt(e),n}function ii(e){mt(e),gt(e),X(e)}function wi(e){e.movable.color=e.movable.dests=e.animation.current=void 0,ii(e)}function Mt(e,t,i){let n=Math.floor(8*(e[0]-i.left)/i.width);t||(n=7-n);let r=7-Math.floor(8*(e[1]-i.top)/i.height);return t||(r=7-r),n>=0&&n<8&&r>=0&&r<8?G([n,r]):void 0}function Zr(e,t,i,n){const r=T(e),o=rn.filter(l=>un(r[0],r[1],l[0],l[1])||cn(r[0],r[1],l[0],l[1])),s=o.map(l=>an(G(l),i,n)).map(l=>Vt(t,l)),[,a]=s.reduce((l,c,p)=>l[0]<c?l:[c,p],[s[0],0]);return G(o[a])}const W=e=>e.orientation==="white",bn="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Yr={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Xr={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function vn(e){e==="start"&&(e=bn);const t=new Map;let i=7,n=0;for(const r of e)switch(r){case" ":case"[":return t;case"/":if(--i,i<0)return t;n=0;break;case"~":{const o=t.get(G([n-1,i]));o&&(o.promoted=!0);break}default:{const o=r.charCodeAt(0);if(o<57)n+=o-48;else{const s=r.toLowerCase();t.set(G([n,i]),{role:Yr[s],color:r===s?"black":"white"}),++n}}}return t}function Jr(e){return zr.map(t=>oe.map(i=>{const n=e.get(i+t);if(n){let r=Xr[n.role];return n.color==="white"&&(r=r.toUpperCase()),n.promoted&&(r+="~"),r}else return"1"}).join("")).join("/").replace(/1{2,}/g,t=>t.length.toString())}function yn(e,t){t.animation&&(ni(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function Cn(e,t){var i,n,r;if(!((i=t.movable)===null||i===void 0)&&i.dests&&(e.movable.dests=void 0),!((n=t.drawable)===null||n===void 0)&&n.autoShapes&&(e.drawable.autoShapes=[]),ni(e,t),t.fen&&(e.pieces=vn(t.fen),e.drawable.shapes=((r=t.drawable)===null||r===void 0?void 0:r.shapes)||[]),"check"in t&&Fr(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&kn(e,e.selected),yn(e,t),!e.movable.rookCastle&&e.movable.dests){const o=e.movable.color==="white"?"1":"8",s="e"+o,a=e.movable.dests.get(s),l=e.pieces.get(s);if(!a||!l||l.role!=="king")return;e.movable.dests.set(s,a.filter(c=>!(c==="a"+o&&a.includes("c"+o))&&!(c==="h"+o&&a.includes("g"+o))))}}function ni(e,t){for(const i in t)Object.prototype.hasOwnProperty.call(t,i)&&(Object.prototype.hasOwnProperty.call(e,i)&&bi(e[i])&&bi(t[i])?ni(e[i],t[i]):e[i]=t[i])}function bi(e){if(typeof e!="object"||e===null)return!1;const t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}const kt=(e,t)=>t.animation.enabled?eo(e,t):lt(e,t);function lt(e,t){const i=e(t);return t.dom.redraw(),i}const ve=(e,t)=>({key:e,pos:T(e),piece:t}),_r=(e,t)=>t.sort((i,n)=>Vt(e.pos,i.pos)-Vt(e.pos,n.pos))[0];function to(e,t){const i=new Map,n=[],r=new Map,o=[],s=[],a=new Map;let l,c,p;for(const[m,P]of e)a.set(m,ve(m,P));for(const m of Ye)l=t.pieces.get(m),c=a.get(m),l?c?Te(l,c.piece)||(o.push(c),s.push(ve(m,l))):s.push(ve(m,l)):c&&o.push(c);for(const m of s)c=_r(m,o.filter(P=>Te(m.piece,P.piece))),c&&(p=[c.pos[0]-m.pos[0],c.pos[1]-m.pos[1]],i.set(m.key,p.concat(p)),n.push(c.key));for(const m of o)n.includes(m.key)||r.set(m.key,m.piece);return{anims:i,fadings:r}}function En(e,t){const i=e.animation.current;if(i===void 0){e.dom.destroyed||e.dom.redrawNow();return}const n=1-(t-i.start)*i.frequency;if(n<=0)e.animation.current=void 0,e.dom.redrawNow();else{const r=io(n);for(const o of i.plan.anims.values())o[2]=o[0]*r,o[3]=o[1]*r;e.dom.redrawNow(!0),requestAnimationFrame((o=performance.now())=>En(e,o))}}function eo(e,t){const i=new Map(t.pieces),n=e(t),r=to(i,t);if(r.anims.size||r.fadings.size){const o=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:r},o||En(t,performance.now())}else t.dom.redraw();return n}const io=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,no=["green","red","blue","yellow"];function ro(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?X(e):ii(e);const i=Et(t),n=Mt(i,W(e),e.dom.bounds());n&&(e.drawable.current={orig:n,pos:i,brush:co(t),snapToValidMove:e.drawable.defaultSnapToValidMove},Mn(e))}function Mn(e){requestAnimationFrame(()=>{const t=e.drawable.current;if(t){const i=Mt(t.pos,W(e),e.dom.bounds());i||(t.snapToValidMove=!1);const n=t.snapToValidMove?Zr(t.orig,t.pos,W(e),e.dom.bounds()):i;n!==t.mouseSq&&(t.mouseSq=n,t.dest=n!==t.orig?n:void 0,e.dom.redrawNow()),Mn(e)}})}function oo(e,t){e.drawable.current&&(e.drawable.current.pos=Et(t))}function so(e){const t=e.drawable.current;t&&(t.mouseSq&&ho(e.drawable,t),Pn(e))}function Pn(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function ao(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),Sn(e.drawable))}function co(e){var t;const i=(e.shiftKey||e.ctrlKey)&&sn(e),n=e.altKey||e.metaKey||((t=e.getModifierState)===null||t===void 0?void 0:t.call(e,"AltGraph"));return no[(i?1:0)+(n?2:0)]}function ho(e,t){const i=r=>r.orig===t.orig&&r.dest===t.dest,n=e.shapes.find(i);n&&(e.shapes=e.shapes.filter(r=>!i(r))),(!n||n.brush!==t.brush)&&e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),Sn(e)}function Sn(e){e.onChange&&e.onChange(e.shapes)}function lo(e,t){if(!(e.trustAllEvents||t.isTrusted)||t.buttons!==void 0&&t.buttons>1||t.touches&&t.touches.length>1)return;const i=e.dom.bounds(),n=Et(t),r=Mt(n,W(e),i);if(!r)return;const o=e.pieces.get(r),s=e.selected;if(!s&&e.drawable.enabled&&(e.drawable.eraseOnClick||!o||o.color!==e.turnColor)&&ao(e),t.cancelable!==!1&&(!t.touches||e.blockTouchScroll||o||s||uo(e,n)))t.preventDefault();else if(t.touches)return;const a=!!e.premovable.current,l=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&ti(e,e.selected,r)?kt(m=>Be(m,r),e):Be(e,r);const c=e.selected===r,p=An(e,r);if(o&&p&&c&&Qr(e,r)){e.draggable.current={orig:r,piece:o,origPos:n,pos:n,started:e.draggable.autoDistance&&e.stats.dragged,element:p,previouslySelected:s,originTarget:t.target,keyHasChanged:!1},p.cgDragging=!0,p.classList.add("dragging");const m=e.dom.elements.ghost;m&&(m.className=`ghost ${o.color} ${o.role}`,et(m,Zt(i)(T(r),W(e))),Je(m,!0)),ri(e)}else a&&mt(e),l&&gt(e);e.dom.redraw()}function uo(e,t){const i=W(e),n=e.dom.bounds(),r=Math.pow(n.width/8,2);for(const o of e.pieces.keys()){const s=an(o,i,n);if(Vt(s,t)<=r)return!0}return!1}function fo(e,t,i,n){const r="a0";e.pieces.set(r,t),e.dom.redraw();const o=Et(i);e.draggable.current={orig:r,piece:t,origPos:o,pos:o,started:!0,element:()=>An(e,r),originTarget:i.target,newPiece:!0,force:!!n,keyHasChanged:!1},ri(e)}function ri(e){requestAnimationFrame(()=>{var t;const i=e.draggable.current;if(!i)return;!((t=e.animation.current)===null||t===void 0)&&t.plan.anims.has(i.orig)&&(e.animation.current=void 0);const n=e.pieces.get(i.orig);if(!n||!Te(n,i.piece))ae(e);else if(!i.started&&Vt(i.pos,i.origPos)>=Math.pow(e.draggable.distance,2)&&(i.started=!0),i.started){if(typeof i.element=="function"){const o=i.element();if(!o)return;o.cgDragging=!0,o.classList.add("dragging"),i.element=o}const r=e.dom.bounds();et(i.element,[i.pos[0]-r.left-r.width/16,i.pos[1]-r.top-r.height/16]),i.keyHasChanged||(i.keyHasChanged=i.orig!==Mt(i.pos,W(e),r))}ri(e)})}function po(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=Et(t))}function mo(e,t){const i=e.draggable.current;if(!i)return;if(t.type==="touchend"&&t.cancelable!==!1&&t.preventDefault(),t.type==="touchend"&&i.originTarget!==t.target&&!i.newPiece){e.draggable.current=void 0;return}mt(e),gt(e);const n=Et(t)||i.pos,r=Mt(n,W(e),e.dom.bounds());r&&i.started&&i.orig!==r?i.newPiece?gn(e,i.orig,r,i.force):(e.stats.ctrlKey=t.ctrlKey,mn(e,i.orig,r)&&(e.stats.dragged=!0)):i.newPiece?e.pieces.delete(i.orig):e.draggable.deleteOnDropOff&&!r&&(e.pieces.delete(i.orig),Q(e.events.change)),(i.orig===i.previouslySelected||i.keyHasChanged)&&(i.orig===r||!r)?X(e):e.selectable.enabled||X(e),On(e),e.draggable.current=void 0,e.dom.redraw()}function ae(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,X(e),On(e),e.dom.redraw())}function On(e){const t=e.dom.elements;t.ghost&&Je(t.ghost,!1)}function An(e,t){let i=e.dom.elements.board.firstChild;for(;i;){if(i.cgKey===t&&i.tagName==="PIECE")return i;i=i.nextSibling}}function go(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{vi(e,2),setTimeout(()=>vi(e,void 0),120)},120)}function vi(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function ko(e,t){function i(){Kr(e),t()}return{set(n){n.orientation&&n.orientation!==e.orientation&&i(),yn(e,n),(n.fen?kt:lt)(r=>Cn(r,n),e)},state:e,getFen:()=>Jr(e.pieces),toggleOrientation:i,setPieces(n){kt(r=>Dr(r,n),e)},selectSquare(n,r){n?kt(o=>Be(o,n,r),e):e.selected&&(X(e),e.dom.redraw())},move(n,r){kt(o=>fn(o,n,r),e)},newPiece(n,r){kt(o=>_e(o,n,r),e)},playPremove(){if(e.premovable.current){if(kt(Wr,e))return!0;e.dom.redraw()}return!1},playPredrop(n){if(e.predroppable.current){const r=Gr(e,n);return e.dom.redraw(),r}return!1},cancelPremove(){lt(mt,e)},cancelPredrop(){lt(gt,e)},cancelMove(){lt(n=>{ii(n),ae(n)},e)},stop(){lt(n=>{wi(n),ae(n)},e)},explode(n){go(e,n)},setAutoShapes(n){lt(r=>r.drawable.autoShapes=n,e)},setShapes(n){lt(r=>r.drawable.shapes=n,e)},getKeyAtDomPos(n){return Mt(n,W(e),e.dom.bounds())},redrawAll:t,dragNewPiece(n,r,o){fo(e,n,r,o)},destroy(){wi(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function wo(){return{pieces:vn(bn),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:Nr()}}const yi={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function bo(){const e=F("defs"),t=j(F("filter"),{id:"cg-filter-blur"});return t.appendChild(j(F("feGaussianBlur"),{stdDeviation:"0.019"})),e.appendChild(t),e}function vo(e,t,i){var n;const r=e.drawable,o=r.current,s=o&&o.mouseSq?o:void 0,a=new Map,l=e.dom.bounds(),c=r.autoShapes.filter(k=>!k.piece);for(const k of r.shapes.concat(c).concat(s?[s]:[])){if(!k.dest)continue;const u=(n=a.get(k.dest))!==null&&n!==void 0?n:new Set,f=le(he(T(k.orig),e.orientation),l),g=le(he(T(k.dest),e.orientation),l);u.add(Ke(f,g)),a.set(k.dest,u)}const p=r.shapes.concat(c).map(k=>({shape:k,current:!1,hash:Ci(k,Le(k.dest,a),!1,l)}));s&&p.push({shape:s,current:!0,hash:Ci(s,Le(s.dest,a),!0,l)});const m=p.map(k=>k.hash).join(";");if(m===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=m;const P=t.querySelector("defs");yo(r,p,P),Co(p,t.querySelector("g"),i.querySelector("g"),k=>Po(e,k,r.brushes,a,l))}function yo(e,t,i){var n;const r=new Map;let o;for(const l of t.filter(c=>c.shape.dest&&c.shape.brush))o=Rn(e.brushes[l.shape.brush],l.shape.modifiers),!((n=l.shape.modifiers)===null||n===void 0)&&n.hilite&&r.set(ce(o).key,ce(o)),r.set(o.key,o);const s=new Set;let a=i.firstElementChild;for(;a;)s.add(a.getAttribute("cgKey")),a=a.nextElementSibling;for(const[l,c]of r.entries())s.has(l)||i.appendChild(Ao(c))}function Co(e,t,i,n){const r=new Map;for(const o of e)r.set(o.hash,!1);for(const o of[t,i]){const s=[];let a=o.firstElementChild,l;for(;a;)l=a.getAttribute("cgHash"),r.has(l)?r.set(l,!0):s.push(a),a=a.nextElementSibling;for(const c of s)o.removeChild(c)}for(const o of e.filter(s=>!r.get(s.hash)))for(const s of n(o))s.isCustom?i.appendChild(s.el):t.appendChild(s.el)}function Ci({orig:e,dest:t,brush:i,piece:n,modifiers:r,customSvg:o,label:s},a,l,c){var p,m;return[c.width,c.height,l,e,t,i,a&&"-",n&&Eo(n),r&&Mo(r),o&&`custom-${Ei(o.html)},${(m=(p=o.center)===null||p===void 0?void 0:p[0])!==null&&m!==void 0?m:"o"}`,s&&`label-${Ei(s.text)}`].filter(P=>P).join(",")}function Eo(e){return[e.color,e.role,e.scale].filter(t=>t).join(",")}function Mo(e){return[e.lineWidth,e.hilite&&"*"].filter(t=>t).join(",")}function Ei(e){let t=0;for(let i=0;i<e.length;i++)t=(t<<5)-t+e.charCodeAt(i)>>>0;return t.toString()}function Po(e,{shape:t,current:i,hash:n},r,o,s){var a,l;const c=le(he(T(t.orig),e.orientation),s),p=t.dest?le(he(T(t.dest),e.orientation),s):c,m=t.brush&&Rn(r[t.brush],t.modifiers),P=o.get(t.dest),k=[];if(m){const u=j(F("g"),{cgHash:n});k.push({el:u}),c[0]!==p[0]||c[1]!==p[1]?u.appendChild(Oo(t,m,c,p,i,Le(t.dest,o))):u.appendChild(So(r[t.brush],c,i,s))}if(t.label){const u=t.label;(a=u.fill)!==null&&a!==void 0||(u.fill=t.brush&&r[t.brush].color);const f=t.brush?void 0:"tr";k.push({el:Ro(u,n,c,p,P,f),isCustom:!0})}if(t.customSvg){const u=(l=t.customSvg.center)!==null&&l!==void 0?l:"orig",[f,g]=u==="label"?zn(c,p,P).map(y=>y-.5):u==="dest"?p:c,C=j(F("g"),{transform:`translate(${f},${g})`,cgHash:n});C.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${t.customSvg.html}</svg>`,k.push({el:C,isCustom:!0})}return k}function So(e,t,i,n){const r=xo(),o=(n.width+n.height)/(4*Math.max(n.width,n.height));return j(F("circle"),{stroke:e.color,"stroke-width":r[i?0:1],fill:"none",opacity:xn(e,i),cx:t[0],cy:t[1],r:o-r[1]/2})}function ce(e){return["#ffffff","#fff","white"].includes(e.color)?yi.hilitePrimary:yi.hiliteWhite}function Oo(e,t,i,n,r,o){var s;function a(p){var m;const P=qo(o&&!r),k=n[0]-i[0],u=n[1]-i[1],f=Math.atan2(u,k),g=Math.cos(f)*P,C=Math.sin(f)*P;return j(F("line"),{stroke:p?ce(t).color:t.color,"stroke-width":zo(t,r)+(p?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${p?ce(t).key:t.key})`,opacity:!((m=e.modifiers)===null||m===void 0)&&m.hilite?1:xn(t,r),x1:i[0],y1:i[1],x2:n[0]-g,y2:n[1]-C})}if(!(!((s=e.modifiers)===null||s===void 0)&&s.hilite))return a(!1);const l=F("g"),c=j(F("g"),{filter:"url(#cg-filter-blur)"});return c.appendChild(No(i,n)),c.appendChild(a(!0)),l.appendChild(c),l.appendChild(a(!1)),l}function Ao(e){const t=j(F("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return t.appendChild(j(F("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function Ro(e,t,i,n,r,o){var s;const a=.4*.75**e.text.length,l=zn(i,n,r),c=o==="tr"?.4:0,p=j(F("g"),{transform:`translate(${l[0]+c},${l[1]-c})`,cgHash:t});p.appendChild(j(F("circle"),{r:.4/2,"fill-opacity":o?1:.8,"stroke-opacity":o?1:.7,"stroke-width":.03,fill:(s=e.fill)!==null&&s!==void 0?s:"#666",stroke:"white"}));const m=j(F("text"),{"font-size":a,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return m.innerHTML=e.text,p.appendChild(m),p}function he(e,t){return t==="white"?e:[7-e[0],7-e[1]]}function Le(e,t){return(e&&t.has(e)&&t.get(e).size>1)===!0}function F(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function j(e,t){for(const i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.setAttribute(i,t[i]);return e}function Rn(e,t){return t?{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(i=>i).join("")}:e}function xo(){return[3/64,4/64]}function zo(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function xn(e,t){return(e.opacity||1)*(t?.9:1)}function qo(e){return(e?20:10)/64}function le(e,t){const i=Math.min(1,t.width/t.height),n=Math.min(1,t.height/t.width);return[(e[0]-3.5)*i,(3.5-e[1])*n]}function No(e,t){const i={from:[Math.floor(Math.min(e[0],t[0])),Math.floor(Math.min(e[1],t[1]))],to:[Math.ceil(Math.max(e[0],t[0])),Math.ceil(Math.max(e[1],t[1]))]};return j(F("rect"),{x:i.from[0],y:i.from[1],width:i.to[0]-i.from[0],height:i.to[1]-i.from[1],fill:"none",stroke:"none"})}function Ke(e,t,i=!0){const n=Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI;return i?(Math.round(n*8/Math.PI)+16)%16:n}function To(e,t){return Math.sqrt([e[0]-t[0],e[1]-t[1]].reduce((i,n)=>i+n*n,0))}function zn(e,t,i){let n=To(e,t);const r=Ke(e,t,!1);if(i&&(n-=33/64,i.size>1)){n-=10/64;const o=Ke(e,t);(i.has((o+1)%16)||i.has((o+15)%16))&&o&1&&(n-=.4)}return[e[0]-Math.cos(r)*n,e[1]-Math.sin(r)*n].map(o=>o+.5)}function Bo(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(const l of xr)e.classList.toggle("orientation-"+l,t.orientation===l);e.classList.toggle("manipulable",!t.viewOnly);const i=st("cg-container");e.appendChild(i);const n=st("cg-board");i.appendChild(n);let r,o,s;if(t.drawable.visible&&(r=j(F("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),r.appendChild(bo()),r.appendChild(F("g")),o=j(F("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),o.appendChild(F("g")),s=st("cg-auto-pieces"),i.appendChild(r),i.appendChild(o),i.appendChild(s)),t.coordinates){const l=t.orientation==="black"?" black":"",c=t.ranksPosition==="left"?" left":"";if(t.coordinatesOnSquares){const p=t.orientation==="white"?m=>m+1:m=>8-m;oe.forEach((m,P)=>i.appendChild(ye(se.map(k=>m+k),"squares rank"+p(P)+l+c)))}else i.appendChild(ye(se,"ranks"+l+c)),i.appendChild(ye(oe,"files"+l))}let a;return t.draggable.enabled&&t.draggable.showGhost&&(a=st("piece","ghost"),Je(a,!1),i.appendChild(a)),{board:n,container:i,wrap:e,ghost:a,svg:r,customSvg:o,autoPieces:s}}function ye(e,t){const i=st("coords",t);let n;for(const r of e)n=st("coord"),n.textContent=r,i.appendChild(n);return i}function Lo(e,t){if(!e.dropmode.active)return;mt(e),gt(e);const i=e.dropmode.piece;if(i){e.pieces.set("a0",i);const n=Et(t),r=n&&Mt(n,W(e),e.dom.bounds());r&&gn(e,"a0",r)}e.dom.redraw()}function Ko(e,t){const i=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&i.addEventListener("contextmenu",r=>r.preventDefault()),e.viewOnly)return;const n=Fo(e);i.addEventListener("touchstart",n,{passive:!1}),i.addEventListener("mousedown",n,{passive:!1})}function Do(e,t){const i=[];if("ResizeObserver"in window||i.push(Kt(document.body,"chessground.resize",t)),!e.viewOnly){const n=Mi(e,po,oo),r=Mi(e,mo,so);for(const s of["touchmove","mousemove"])i.push(Kt(document,s,n));for(const s of["touchend","mouseup"])i.push(Kt(document,s,r));const o=()=>e.dom.bounds.clear();i.push(Kt(document,"scroll",o,{capture:!0,passive:!0})),i.push(Kt(window,"resize",o,{passive:!0}))}return()=>i.forEach(n=>n())}function Kt(e,t,i,n){return e.addEventListener(t,i,n),()=>e.removeEventListener(t,i,n)}const Fo=e=>t=>{e.draggable.current?ae(e):e.drawable.current?Pn(e):t.shiftKey||sn(t)?e.drawable.enabled&&ro(e,t):e.viewOnly||(e.dropmode.active?Lo(e,t):lo(e,t))},Mi=(e,t,i)=>n=>{e.drawable.current?e.drawable.enabled&&i(e,n):e.viewOnly||t(e,n)};function Io(e){const t=W(e),i=Zt(e.dom.bounds()),n=e.dom.elements.board,r=e.pieces,o=e.animation.current,s=o?o.plan.anims:new Map,a=o?o.plan.fadings:new Map,l=e.draggable.current,c=Ho(e),p=new Set,m=new Set,P=new Map,k=new Map;let u,f,g,C,y,O,M,E,S,A;for(f=n.firstChild;f;){if(u=f.cgKey,qn(f))if(g=r.get(u),y=s.get(u),O=a.get(u),C=f.cgPiece,f.cgDragging&&(!l||l.orig!==u)&&(f.classList.remove("dragging"),et(f,i(T(u),t)),f.cgDragging=!1),!O&&f.cgFading&&(f.cgFading=!1,f.classList.remove("fading")),g){if(y&&f.cgAnimating&&C===Dt(g)){const b=T(u);b[0]+=y[2],b[1]+=y[3],f.classList.add("anim"),et(f,i(b,t))}else f.cgAnimating&&(f.cgAnimating=!1,f.classList.remove("anim"),et(f,i(T(u),t)),e.addPieceZIndex&&(f.style.zIndex=Ce(T(u),t)));C===Dt(g)&&(!O||!f.cgFading)?p.add(u):O&&C===Dt(O)?(f.classList.add("fading"),f.cgFading=!0):Ee(P,C,f)}else Ee(P,C,f);else if(Nn(f)){const b=f.className;c.get(u)===b?m.add(u):Ee(k,b,f)}f=f.nextSibling}for(const[b,z]of c)if(!m.has(b)){S=k.get(z),A=S&&S.pop();const N=i(T(b),t);if(A)A.cgKey=b,et(A,N);else{const x=st("square",z);x.cgKey=b,et(x,N),n.insertBefore(x,n.firstChild)}}for(const[b,z]of r)if(y=s.get(b),!p.has(b))if(M=P.get(Dt(z)),E=M&&M.pop(),E){E.cgKey=b,E.cgFading&&(E.classList.remove("fading"),E.cgFading=!1);const N=T(b);e.addPieceZIndex&&(E.style.zIndex=Ce(N,t)),y&&(E.cgAnimating=!0,E.classList.add("anim"),N[0]+=y[2],N[1]+=y[3]),et(E,i(N,t))}else{const N=Dt(z),x=st("piece",N),K=T(b);x.cgPiece=N,x.cgKey=b,y&&(x.cgAnimating=!0,K[0]+=y[2],K[1]+=y[3]),et(x,i(K,t)),e.addPieceZIndex&&(x.style.zIndex=Ce(K,t)),n.appendChild(x)}for(const b of P.values())Si(e,b);for(const b of k.values())Si(e,b)}function $o(e){const t=W(e),i=Zt(e.dom.bounds());let n=e.dom.elements.board.firstChild;for(;n;)(qn(n)&&!n.cgAnimating||Nn(n))&&et(n,i(T(n.cgKey),t)),n=n.nextSibling}function Pi(e){var t,i;const n=e.dom.elements.wrap.getBoundingClientRect(),r=e.dom.elements.container,o=n.height/n.width,s=Math.floor(n.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,a=s*o;r.style.width=s+"px",r.style.height=a+"px",e.dom.bounds.clear(),(t=e.addDimensionsCssVarsTo)===null||t===void 0||t.style.setProperty("---cg-width",s+"px"),(i=e.addDimensionsCssVarsTo)===null||i===void 0||i.style.setProperty("---cg-height",a+"px")}const qn=e=>e.tagName==="PIECE",Nn=e=>e.tagName==="SQUARE";function Si(e,t){for(const i of t)e.dom.elements.board.removeChild(i)}function Ce(e,t){const i=e[1];return`${t?10-i:3+i}`}const Dt=e=>`${e.color} ${e.role}`;function Ho(e){var t,i,n;const r=new Map;if(e.lastMove&&e.highlight.lastMove)for(const a of e.lastMove)nt(r,a,"last-move");if(e.check&&e.highlight.check&&nt(r,e.check,"check"),e.selected&&(nt(r,e.selected,"selected"),e.movable.showDests)){const a=(t=e.movable.dests)===null||t===void 0?void 0:t.get(e.selected);if(a)for(const c of a)nt(r,c,"move-dest"+(e.pieces.has(c)?" oc":""));const l=(n=(i=e.premovable.customDests)===null||i===void 0?void 0:i.get(e.selected))!==null&&n!==void 0?n:e.premovable.dests;if(l)for(const c of l)nt(r,c,"premove-dest"+(e.pieces.has(c)?" oc":""))}const o=e.premovable.current;if(o)for(const a of o)nt(r,a,"current-premove");else e.predroppable.current&&nt(r,e.predroppable.current.key,"current-premove");const s=e.exploding;if(s)for(const a of s.keys)nt(r,a,"exploding"+s.stage);return e.highlight.custom&&e.highlight.custom.forEach((a,l)=>{nt(r,l,a)}),r}function nt(e,t,i){const n=e.get(t);n?e.set(t,`${n} ${i}`):e.set(t,i)}function Ee(e,t,i){const n=e.get(t);n?n.push(i):e.set(t,[i])}function jo(e,t,i){const n=new Map,r=[];for(const a of e)n.set(a.hash,!1);let o=t.firstElementChild,s;for(;o;)s=o.getAttribute("cgHash"),n.has(s)?n.set(s,!0):r.push(o),o=o.nextElementSibling;for(const a of r)t.removeChild(a);for(const a of e)n.get(a.hash)||t.appendChild(i(a))}function Uo(e,t){const i=e.drawable.autoShapes.filter(n=>n.piece).map(n=>({shape:n,hash:Wo(n),current:!1}));jo(i,t,n=>Qo(e,n,e.dom.bounds()))}function Vo(e){var t;const i=W(e),n=Zt(e.dom.bounds());let r=(t=e.dom.elements.autoPieces)===null||t===void 0?void 0:t.firstChild;for(;r;)on(r,n(T(r.cgKey),i),r.cgScale),r=r.nextSibling}function Qo(e,{shape:t,hash:i},n){var r,o,s;const a=t.orig,l=(r=t.piece)===null||r===void 0?void 0:r.role,c=(o=t.piece)===null||o===void 0?void 0:o.color,p=(s=t.piece)===null||s===void 0?void 0:s.scale,m=st("piece",`${l} ${c}`);return m.setAttribute("cgHash",i),m.cgKey=a,m.cgScale=p,on(m,Zt(n)(T(a),W(e)),p),m}const Wo=e=>{var t,i,n;return[e.orig,(t=e.piece)===null||t===void 0?void 0:t.role,(i=e.piece)===null||i===void 0?void 0:i.color,(n=e.piece)===null||n===void 0?void 0:n.scale].join(",")};function Go(e,t){const i=wo();Cn(i,t||{});function n(){const r="dom"in i?i.dom.unbind:void 0,o=Bo(e,i),s=qr(()=>o.board.getBoundingClientRect()),a=p=>{Io(c),o.autoPieces&&Uo(c,o.autoPieces),!p&&o.svg&&vo(c,o.svg,o.customSvg)},l=()=>{Pi(c),$o(c),o.autoPieces&&Vo(c)},c=i;return c.dom={elements:o,bounds:s,redraw:Zo(a),redrawNow:a,unbind:r},c.drawable.prevSvgHash="",Pi(c),a(!1),Ko(c,l),r||(c.dom.unbind=Do(c,l)),c.events.insert&&c.events.insert(o),c}return ko(n(),n)}function Zo(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}function Yo(e,t){return document.createElement(e,t)}function Xo(e,t,i){return document.createElementNS(e,t,i)}function Jo(){return bt(document.createDocumentFragment())}function _o(e){return document.createTextNode(e)}function ts(e){return document.createComment(e)}function es(e,t,i){if(at(e)){let n=e;for(;n&&at(n);)n=bt(n).parent;e=n??e}at(t)&&(t=bt(t,e)),i&&at(i)&&(i=bt(i).firstChildNode),e.insertBefore(t,i)}function is(e,t){e.removeChild(t)}function ns(e,t){at(t)&&(t=bt(t,e)),e.appendChild(t)}function Tn(e){if(at(e)){for(;e&&at(e);)e=bt(e).parent;return e??null}return e.parentNode}function rs(e){var t;if(at(e)){const i=bt(e),n=Tn(i);if(n&&i.lastChildNode){const r=Array.from(n.childNodes),o=r.indexOf(i.lastChildNode);return(t=r[o+1])!==null&&t!==void 0?t:null}return null}return e.nextSibling}function os(e){return e.tagName}function ss(e,t){e.textContent=t}function as(e){return e.textContent}function cs(e){return e.nodeType===1}function hs(e){return e.nodeType===3}function ls(e){return e.nodeType===8}function at(e){return e.nodeType===11}function bt(e,t){var i,n,r;const o=e;return(i=o.parent)!==null&&i!==void 0||(o.parent=t??null),(n=o.firstChildNode)!==null&&n!==void 0||(o.firstChildNode=e.firstChild),(r=o.lastChildNode)!==null&&r!==void 0||(o.lastChildNode=e.lastChild),o}const us={createElement:Yo,createElementNS:Xo,createTextNode:_o,createDocumentFragment:Jo,createComment:ts,insertBefore:es,removeChild:is,appendChild:ns,parentNode:Tn,nextSibling:rs,tagName:os,setTextContent:ss,getTextContent:as,isElement:cs,isText:hs,isComment:ls,isDocumentFragment:at};function Qt(e,t,i,n,r){const o=t===void 0?void 0:t.key;return{sel:e,data:t,children:i,text:n,elm:r,key:o}}const ue=Array.isArray;function _t(e){return typeof e=="string"||typeof e=="number"||e instanceof String||e instanceof Number}function Jt(e){return e===void 0}function U(e){return e!==void 0}const Me=Qt("",{},[],void 0,void 0);function Ft(e,t){var i,n;const r=e.key===t.key,o=((i=e.data)===null||i===void 0?void 0:i.is)===((n=t.data)===null||n===void 0?void 0:n.is),s=e.sel===t.sel,a=!e.sel&&e.sel===t.sel?typeof e.text==typeof t.text:!0;return s&&r&&o&&a}function ds(){throw new Error("The document fragment is not supported on this platform.")}function fs(e,t){return e.isElement(t)}function ps(e,t){return e.isDocumentFragment(t)}function ms(e,t,i){var n;const r={};for(let o=t;o<=i;++o){const s=(n=e[o])===null||n===void 0?void 0:n.key;s!==void 0&&(r[s]=o)}return r}const gs=["create","update","remove","destroy","pre","post"];function ks(e,t,i){const n={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},r=us;for(const u of gs)for(const f of e){const g=f[u];g!==void 0&&n[u].push(g)}function o(u){const f=u.id?"#"+u.id:"",g=u.getAttribute("class"),C=g?"."+g.split(" ").join("."):"";return Qt(r.tagName(u).toLowerCase()+f+C,{},[],void 0,u)}function s(u){return Qt(void 0,{},[],void 0,u)}function a(u,f){return function(){if(--f===0){const g=r.parentNode(u);g!==null&&r.removeChild(g,u)}}}function l(u,f){var g,C,y,O;let M,E=u.data;if(E!==void 0){const b=(g=E.hook)===null||g===void 0?void 0:g.init;U(b)&&(b(u),E=u.data)}const S=u.children,A=u.sel;if(A==="!")Jt(u.text)&&(u.text=""),u.elm=r.createComment(u.text);else if(A==="")u.elm=r.createTextNode(u.text);else if(A!==void 0){const b=A.indexOf("#"),z=A.indexOf(".",b),N=b>0?b:A.length,x=z>0?z:A.length,K=b!==-1||z!==-1?A.slice(0,Math.min(N,x)):A,J=u.elm=U(E)&&U(M=E.ns)?r.createElementNS(M,K,E):r.createElement(K,E);for(N<x&&J.setAttribute("id",A.slice(N+1,x)),z>0&&J.setAttribute("class",A.slice(x+1).replace(/\./g," ")),M=0;M<n.create.length;++M)n.create[M](Me,u);if(_t(u.text)&&(!ue(S)||S.length===0)&&r.appendChild(J,r.createTextNode(u.text)),ue(S))for(M=0;M<S.length;++M){const ci=S[M];ci!=null&&r.appendChild(J,l(ci,f))}const Xt=u.data.hook;U(Xt)&&((C=Xt.create)===null||C===void 0||C.call(Xt,Me,u),Xt.insert&&f.push(u))}else if(!((y=void 0)===null||y===void 0)&&y.fragments&&u.children){for(u.elm=((O=r.createDocumentFragment)!==null&&O!==void 0?O:ds)(),M=0;M<n.create.length;++M)n.create[M](Me,u);for(M=0;M<u.children.length;++M){const b=u.children[M];b!=null&&r.appendChild(u.elm,l(b,f))}}else u.elm=r.createTextNode(u.text);return u.elm}function c(u,f,g,C,y,O){for(;C<=y;++C){const M=g[C];M!=null&&r.insertBefore(u,l(M,O),f)}}function p(u){var f,g;const C=u.data;if(C!==void 0){(g=(f=C?.hook)===null||f===void 0?void 0:f.destroy)===null||g===void 0||g.call(f,u);for(let y=0;y<n.destroy.length;++y)n.destroy[y](u);if(u.children!==void 0)for(let y=0;y<u.children.length;++y){const O=u.children[y];O!=null&&typeof O!="string"&&p(O)}}}function m(u,f,g,C){for(var y,O;g<=C;++g){let M,E;const S=f[g];if(S!=null)if(U(S.sel)){p(S),M=n.remove.length+1,E=a(S.elm,M);for(let b=0;b<n.remove.length;++b)n.remove[b](S,E);const A=(O=(y=S?.data)===null||y===void 0?void 0:y.hook)===null||O===void 0?void 0:O.remove;U(A)?A(S,E):E()}else S.children?(p(S),m(u,S.children,0,S.children.length-1)):r.removeChild(u,S.elm)}}function P(u,f,g,C){let y=0,O=0,M=f.length-1,E=f[0],S=f[M],A=g.length-1,b=g[0],z=g[A],N,x,K,J;for(;y<=M&&O<=A;)E==null?E=f[++y]:S==null?S=f[--M]:b==null?b=g[++O]:z==null?z=g[--A]:Ft(E,b)?(k(E,b,C),E=f[++y],b=g[++O]):Ft(S,z)?(k(S,z,C),S=f[--M],z=g[--A]):Ft(E,z)?(k(E,z,C),r.insertBefore(u,E.elm,r.nextSibling(S.elm)),E=f[++y],z=g[--A]):Ft(S,b)?(k(S,b,C),r.insertBefore(u,S.elm,E.elm),S=f[--M],b=g[++O]):(N===void 0&&(N=ms(f,y,M)),x=N[b.key],Jt(x)?(r.insertBefore(u,l(b,C),E.elm),b=g[++O]):Jt(N[z.key])?(r.insertBefore(u,l(z,C),r.nextSibling(S.elm)),z=g[--A]):(K=f[x],K.sel!==b.sel?r.insertBefore(u,l(b,C),E.elm):(k(K,b,C),f[x]=void 0,r.insertBefore(u,K.elm,E.elm)),b=g[++O]));O<=A&&(J=g[A+1]==null?null:g[A+1].elm,c(u,J,g,O,A,C)),y<=M&&m(u,f,y,M)}function k(u,f,g){var C,y,O,M,E,S,A,b;const z=(C=f.data)===null||C===void 0?void 0:C.hook;(y=z?.prepatch)===null||y===void 0||y.call(z,u,f);const N=f.elm=u.elm;if(u===f)return;if(f.data!==void 0||U(f.text)&&f.text!==u.text){(O=f.data)!==null&&O!==void 0||(f.data={}),(M=u.data)!==null&&M!==void 0||(u.data={});for(let J=0;J<n.update.length;++J)n.update[J](u,f);(A=(S=(E=f.data)===null||E===void 0?void 0:E.hook)===null||S===void 0?void 0:S.update)===null||A===void 0||A.call(S,u,f)}const x=u.children,K=f.children;Jt(f.text)?U(x)&&U(K)?x!==K&&P(N,x,K,g):U(K)?(U(u.text)&&r.setTextContent(N,""),c(N,null,K,0,K.length-1,g)):U(x)?m(N,x,0,x.length-1):U(u.text)&&r.setTextContent(N,""):u.text!==f.text&&(U(x)&&m(N,x,0,x.length-1),r.setTextContent(N,f.text)),(b=z?.postpatch)===null||b===void 0||b.call(z,u,f)}return function(u,f){let g,C,y;const O=[];for(g=0;g<n.pre.length;++g)n.pre[g]();for(fs(r,u)?u=o(u):ps(r,u)&&(u=s(u)),Ft(u,f)?k(u,f,O):(C=u.elm,y=r.parentNode(C),l(f,O),y!==null&&(r.insertBefore(y,f.elm,r.nextSibling(C)),m(y,[u],0,0))),g=0;g<O.length;++g)O[g].data.hook.insert(O[g]);for(g=0;g<n.post.length;++g)n.post[g]();return f}}function Bn(e,t,i){if(e.ns="http://www.w3.org/2000/svg",i!=="foreignObject"&&t!==void 0)for(let n=0;n<t.length;++n){const r=t[n];if(typeof r=="string")continue;const o=r.data;o!==void 0&&Bn(o,r.children,r.sel)}}function Rt(e,t,i){let n={},r,o,s;if(i!==void 0?(t!==null&&(n=t),ue(i)?r=i:_t(i)?o=i.toString():i&&i.sel&&(r=[i])):t!=null&&(ue(t)?r=t:_t(t)?o=t.toString():t&&t.sel?r=[t]:n=t),r!==void 0)for(s=0;s<r.length;++s)_t(r[s])&&(r[s]=Qt(void 0,void 0,void 0,r[s],void 0));return e.startsWith("svg")&&(e.length===3||e[3]==="."||e[3]==="#")&&Bn(n,r,e),Qt(e,n,r,o,void 0)}const ws="http://www.w3.org/1999/xlink",bs="http://www.w3.org/2000/xmlns/",vs="http://www.w3.org/XML/1998/namespace",Oi=58,ys=120,Cs=109;function Ai(e,t){let i;const n=t.elm;let r=e.data.attrs,o=t.data.attrs;if(!(!r&&!o)&&r!==o){r=r||{},o=o||{};for(i in o){const s=o[i];r[i]!==s&&(s===!0?n.setAttribute(i,""):s===!1?n.removeAttribute(i):i.charCodeAt(0)!==ys?n.setAttribute(i,s):i.charCodeAt(3)===Oi?n.setAttributeNS(vs,i,s):i.charCodeAt(5)===Oi?i.charCodeAt(1)===Cs?n.setAttributeNS(bs,i,s):n.setAttributeNS(ws,i,s):n.setAttribute(i,s))}for(i in r)i in o||n.removeAttribute(i)}}const Es={create:Ai,update:Ai};function Ri(e,t){let i,n;const r=t.elm;let o=e.data.class,s=t.data.class;if(!(!o&&!s)&&o!==s){o=o||{},s=s||{};for(n in o)o[n]&&!Object.prototype.hasOwnProperty.call(s,n)&&r.classList.remove(n);for(n in s)i=s[n],i!==o[n]&&r.classList[i?"add":"remove"](n)}}const Ms={create:Ri,update:Ri};function Ln(e,t,i){if(typeof e=="function")e.call(t,i,t);else if(typeof e=="object")for(let n=0;n<e.length;n++)Ln(e[n],t,i)}function Ps(e,t){const i=e.type,n=t.data.on;n&&n[i]&&Ln(n[i],t,e)}function Ss(){return function e(t){Ps(t,e.vnode)}}function Pe(e,t){const i=e.data.on,n=e.listener,r=e.elm,o=t&&t.data.on,s=t&&t.elm;let a;if(i!==o){if(i&&n)if(o)for(a in i)o[a]||r.removeEventListener(a,n,!1);else for(a in i)r.removeEventListener(a,n,!1);if(o){const l=t.listener=e.listener||Ss();if(l.vnode=t,i)for(a in o)i[a]||s.addEventListener(a,l,!1);else for(a in o)s.addEventListener(a,l,!1)}}}const Os={create:Pe,update:Pe,destroy:Pe},xi=typeof window?.requestAnimationFrame=="function"?window.requestAnimationFrame.bind(window):setTimeout,As=function(e){xi(function(){xi(e)})};let De=!1;function Rs(e,t,i){As(function(){e[t]=i})}function zi(e,t){let i,n;const r=t.elm;let o=e.data.style,s=t.data.style;if(!o&&!s||o===s)return;o=o||{},s=s||{};const a="delayed"in o;for(n in o)n in s||(n[0]==="-"&&n[1]==="-"?r.style.removeProperty(n):r.style[n]="");for(n in s)if(i=s[n],n==="delayed"&&s.delayed)for(const l in s.delayed)i=s.delayed[l],(!a||i!==o.delayed[l])&&Rs(r.style,l,i);else n!=="remove"&&i!==o[n]&&(n[0]==="-"&&n[1]==="-"?r.style.setProperty(n,i):r.style[n]=i)}function xs(e){let t,i;const n=e.elm,r=e.data.style;if(!(!r||!(t=r.destroy)))for(i in t)n.style[i]=t[i]}function zs(e,t){const i=e.data.style;if(!i||!i.remove){t();return}De||(e.elm.offsetLeft,De=!0);let n;const r=e.elm;let o=0;const s=i.remove;let a=0;const l=[];for(n in s)l.push(n),r.style[n]=s[n];const c=getComputedStyle(r)["transition-property"].split(", ");for(;o<c.length;++o)l.indexOf(c[o])!==-1&&a++;r.addEventListener("transitionend",function(p){p.target===r&&--a,a===0&&t()})}function qs(){De=!1}const Ns={pre:qs,create:zi,update:zi,destroy:xs,remove:zs};function Ts(e){return{insert:t=>e(t.elm)}}function qi(e){return Rt("div.blue.merida",{attrs:{tabindex:0},class:{darken:e.isPromotionPromptOpened()},hook:Ts(t=>{e.setGround(Go(t.querySelector(".cg-wrap"),Ks(e,t)))})},[Bs(e)])}const Bs=e=>Rt("div.lpv__board",Rt("div.cg-wrap",{class:{"cg-promotion":e.isPromotionPromptOpened(),"cg-promotion--open":e.isPromotionPromptOpened()},on:{click:()=>{e.isPromotionPromptOpened()&&e.cancelPromotion()}}},e.isPromotionPromptOpened()?Ls(e):void 0)),Ls=e=>{const t=["queen","knight","rook","bishop"],i=e.getPromotionDest(),n=e.getPromotionColor(),r=e.cgState().orientation;let o=i.charCodeAt(0)-97,s=n=="white"?0:7,a=n=="white"?1:-1;return r=="black"&&(o=7-o,s=7-s,a*=-1),t.map((l,c)=>Rt("cg-board",Rt("square.blue.merida",{style:{top:`${(s+c*a)*12.5}%`,left:`${o*12.5}%`},on:{click:()=>e.resolvePromotion(l)}},Rt(`piece.${n}.${l}`))))};function Ks(e,t){return{viewOnly:!1,addDimensionsCssVarsTo:t,animation:{enabled:!0,duration:300},drawable:{enabled:!0,visible:!0},disableContextMenu:!0,movable:{free:!1},draggable:{enabled:!0},selectable:{enabled:!0},...e.cgState()}}function Ds(e,t,i=!1){const n=ks([Ms,Es,Ns,Os]),r=new Rr(t,i,a),o=qi(r);e.innerHTML="";let s=n(e,o);function a(){s=n(s,qi(r))}return r}const de=["a","b","c","d","e","f","g","h"],Kn=["1","2","3","4","5","6","7","8"],Nt=["white","black"],te=["pawn","knight","bishop","rook","queen","king"],Fs=["a","h"],fe=e=>"role"in e,q=e=>e!==void 0,I=e=>e==="white"?"black":"white",Ct=e=>e>>3,V=e=>e&7,Is=(e,t)=>0<=e&&e<8&&0<=t&&t<8?e+8*t:void 0,It=e=>{switch(e){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function $t(e){switch(e.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function Ht(e){if(e.length===2)return Is(e.charCodeAt(0)-97,e.charCodeAt(1)-49)}const Fe=e=>de[V(e)]+Kn[Ct(e)],$s=e=>{if(e[1]==="@"&&e.length===4){const t=$t(e[0]),i=Ht(e.slice(2));if(t&&q(i))return{role:t,to:i}}else if(e.length===4||e.length===5){const t=Ht(e.slice(0,2)),i=Ht(e.slice(2,4));let n;if(e.length===5&&(n=$t(e[4]),!n))return;if(q(t)&&q(i))return{from:t,to:i,promotion:n}}},oi=(e,t)=>e==="white"?t==="a"?2:6:t==="a"?58:62,si=(e,t)=>e==="white"?t==="a"?3:5:t==="a"?59:61,Ni=e=>(e=e-(e>>>1&1431655765),e=(e&858993459)+(e>>>2&858993459),Math.imul(e+(e>>>4)&252645135,16843009)>>24),Ie=e=>(e=e>>>8&16711935|(e&16711935)<<8,e>>>16&65535|(e&65535)<<16),Ti=e=>(e=e>>>1&1431655765|(e&1431655765)<<1,e=e>>>2&858993459|(e&858993459)<<2,e=e>>>4&252645135|(e&252645135)<<4,Ie(e));class d{constructor(t,i){this.lo=t|0,this.hi=i|0}static fromSquare(t){return t>=32?new d(0,1<<t-32):new d(1<<t,0)}static fromRank(t){return new d(255,0).shl64(8*t)}static fromFile(t){return new d(16843009<<t,16843009<<t)}static empty(){return new d(0,0)}static full(){return new d(4294967295,4294967295)}static corners(){return new d(129,2164260864)}static center(){return new d(402653184,24)}static backranks(){return new d(255,4278190080)}static backrank(t){return t==="white"?new d(255,0):new d(0,4278190080)}static lightSquares(){return new d(1437226410,1437226410)}static darkSquares(){return new d(2857740885,2857740885)}complement(){return new d(~this.lo,~this.hi)}xor(t){return new d(this.lo^t.lo,this.hi^t.hi)}union(t){return new d(this.lo|t.lo,this.hi|t.hi)}intersect(t){return new d(this.lo&t.lo,this.hi&t.hi)}diff(t){return new d(this.lo&~t.lo,this.hi&~t.hi)}intersects(t){return this.intersect(t).nonEmpty()}isDisjoint(t){return this.intersect(t).isEmpty()}supersetOf(t){return t.diff(this).isEmpty()}subsetOf(t){return this.diff(t).isEmpty()}shr64(t){return t>=64?d.empty():t>=32?new d(this.hi>>>t-32,0):t>0?new d(this.lo>>>t^this.hi<<32-t,this.hi>>>t):this}shl64(t){return t>=64?d.empty():t>=32?new d(0,this.lo<<t-32):t>0?new d(this.lo<<t,this.hi<<t^this.lo>>>32-t):this}bswap64(){return new d(Ie(this.hi),Ie(this.lo))}rbit64(){return new d(Ti(this.hi),Ti(this.lo))}minus64(t){const i=this.lo-t.lo,n=(i&t.lo&1)+(t.lo>>>1)+(i>>>1)>>>31;return new d(i,this.hi-(t.hi+n))}equals(t){return this.lo===t.lo&&this.hi===t.hi}size(){return Ni(this.lo)+Ni(this.hi)}isEmpty(){return this.lo===0&&this.hi===0}nonEmpty(){return this.lo!==0||this.hi!==0}has(t){return(t>=32?this.hi&1<<t-32:this.lo&1<<t)!==0}set(t,i){return i?this.with(t):this.without(t)}with(t){return t>=32?new d(this.lo,this.hi|1<<t-32):new d(this.lo|1<<t,this.hi)}without(t){return t>=32?new d(this.lo,this.hi&~(1<<t-32)):new d(this.lo&~(1<<t),this.hi)}toggle(t){return t>=32?new d(this.lo,this.hi^1<<t-32):new d(this.lo^1<<t,this.hi)}last(){if(this.hi!==0)return 63-Math.clz32(this.hi);if(this.lo!==0)return 31-Math.clz32(this.lo)}first(){if(this.lo!==0)return 31-Math.clz32(this.lo&-this.lo);if(this.hi!==0)return 63-Math.clz32(this.hi&-this.hi)}withoutFirst(){return this.lo!==0?new d(this.lo&this.lo-1,this.hi):new d(0,this.hi&this.hi-1)}moreThanOne(){return this.hi!==0&&this.lo!==0||(this.lo&this.lo-1)!==0||(this.hi&this.hi-1)!==0}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let t=this.lo,i=this.hi;for(;t!==0;){const n=31-Math.clz32(t&-t);t^=1<<n,yield n}for(;i!==0;){const n=31-Math.clz32(i&-i);i^=1<<n,yield 32+n}}*reversed(){let t=this.lo,i=this.hi;for(;i!==0;){const n=31-Math.clz32(i);i^=1<<n,yield 32+n}for(;t!==0;){const n=31-Math.clz32(t);t^=1<<n,yield n}}}const pe=(e,t)=>{let i=d.empty();for(const n of t){const r=e+n;0<=r&&r<64&&Math.abs(V(e)-V(r))<=2&&(i=i.with(r))}return i},ft=e=>{const t=[];for(let i=0;i<64;i++)t[i]=e(i);return t},Hs=ft(e=>pe(e,[-9,-8,-7,-1,1,7,8,9])),js=ft(e=>pe(e,[-17,-15,-10,-6,6,10,15,17])),Us={white:ft(e=>pe(e,[7,9])),black:ft(e=>pe(e,[-7,-9]))},me=e=>Hs[e],ge=e=>js[e],Yt=(e,t)=>Us[e][t],$e=ft(e=>d.fromFile(V(e)).without(e)),He=ft(e=>d.fromRank(Ct(e)).without(e)),je=ft(e=>{const t=new d(134480385,2151686160),i=8*(Ct(e)-V(e));return(i>=0?t.shl64(i):t.shr64(-i)).without(e)}),Ue=ft(e=>{const t=new d(270549120,16909320),i=8*(Ct(e)+V(e)-7);return(i>=0?t.shl64(i):t.shr64(-i)).without(e)}),Ve=(e,t,i)=>{let n=i.intersect(t),r=n.bswap64();return n=n.minus64(e),r=r.minus64(e.bswap64()),n.xor(r.bswap64()).intersect(t)},Vs=(e,t)=>Ve(d.fromSquare(e),$e[e],t),Qs=(e,t)=>{const i=He[e];let n=t.intersect(i),r=n.rbit64();return n=n.minus64(d.fromSquare(e)),r=r.minus64(d.fromSquare(63-e)),n.xor(r.rbit64()).intersect(i)},Tt=(e,t)=>{const i=d.fromSquare(e);return Ve(i,je[e],t).xor(Ve(i,Ue[e],t))},Bt=(e,t)=>Vs(e,t).xor(Qs(e,t)),ai=(e,t)=>Tt(e,t).xor(Bt(e,t)),Ws=(e,t,i)=>{switch(e.role){case"pawn":return Yt(e.color,t);case"knight":return ge(t);case"bishop":return Tt(t,i);case"rook":return Bt(t,i);case"queen":return ai(t,i);case"king":return me(t)}},Dn=(e,t)=>{const i=d.fromSquare(t);return He[e].intersects(i)?He[e].with(e):Ue[e].intersects(i)?Ue[e].with(e):je[e].intersects(i)?je[e].with(e):$e[e].intersects(i)?$e[e].with(e):d.empty()},Wt=(e,t)=>Dn(e,t).intersect(d.full().shl64(e).xor(d.full().shl64(t))).withoutFirst();class xt{constructor(){}static default(){const t=new xt;return t.reset(),t}reset(){this.occupied=new d(65535,4294901760),this.promoted=d.empty(),this.white=new d(65535,0),this.black=new d(0,4294901760),this.pawn=new d(65280,16711680),this.knight=new d(66,1107296256),this.bishop=new d(36,603979776),this.rook=new d(129,2164260864),this.queen=new d(8,134217728),this.king=new d(16,268435456)}static empty(){const t=new xt;return t.clear(),t}clear(){this.occupied=d.empty(),this.promoted=d.empty();for(const t of Nt)this[t]=d.empty();for(const t of te)this[t]=d.empty()}clone(){const t=new xt;t.occupied=this.occupied,t.promoted=this.promoted;for(const i of Nt)t[i]=this[i];for(const i of te)t[i]=this[i];return t}getColor(t){if(this.white.has(t))return"white";if(this.black.has(t))return"black"}getRole(t){for(const i of te)if(this[i].has(t))return i}get(t){const i=this.getColor(t);if(!i)return;const n=this.getRole(t),r=this.promoted.has(t);return{color:i,role:n,promoted:r}}take(t){const i=this.get(t);return i&&(this.occupied=this.occupied.without(t),this[i.color]=this[i.color].without(t),this[i.role]=this[i.role].without(t),i.promoted&&(this.promoted=this.promoted.without(t))),i}set(t,i){const n=this.take(t);return this.occupied=this.occupied.with(t),this[i.color]=this[i.color].with(t),this[i.role]=this[i.role].with(t),i.promoted&&(this.promoted=this.promoted.with(t)),n}has(t){return this.occupied.has(t)}*[Symbol.iterator](){for(const t of this.occupied)yield[t,this.get(t)]}pieces(t,i){return this[t].intersect(this[i])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(t){return this.pieces(t,"king").singleSquare()}}const Gs=()=>({board:xt.default(),pockets:void 0,turn:"white",castlingRights:d.corners(),epSquare:void 0,remainingChecks:void 0,halfmoves:0,fullmoves:1});class Fn{unwrap(t,i){const n=this._chain(r=>H.ok(t?t(r):r),r=>i?H.ok(i(r)):H.err(r));if(n.isErr)throw n.error;return n.value}map(t,i){return this._chain(n=>H.ok(t(n)),n=>H.err(i?i(n):n))}chain(t,i){return this._chain(t,i||(n=>H.err(n)))}}class Zs extends Fn{constructor(t){super(),this.value=void 0,this.isOk=!0,this.isErr=!1,this.value=t}_chain(t,i){return t(this.value)}}class Ys extends Fn{constructor(t){super(),this.error=void 0,this.isOk=!1,this.isErr=!0,this.error=t}_chain(t,i){return i(this.error)}}var H;(function(e){e.ok=function(t){return new Zs(t)},e.err=function(t){return new Ys(t||new Error)},e.all=function(t){if(Array.isArray(t)){const r=[];for(let o=0;o<t.length;o++){const s=t[o];if(s.isErr)return s;r.push(s.value)}return e.ok(r)}const i={},n=Object.keys(t);for(let r=0;r<n.length;r++){const o=t[n[r]];if(o.isErr)return o;i[n[r]]=o.value}return e.ok(i)}})(H||(H={}));var ut;(function(e){e.Empty="ERR_EMPTY",e.OppositeCheck="ERR_OPPOSITE_CHECK",e.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",e.Kings="ERR_KINGS",e.Variant="ERR_VARIANT"})(ut||(ut={}));class Pt extends Error{}const Xs=(e,t,i,n)=>i[t].intersect(Bt(e,n).intersect(i.rooksAndQueens()).union(Tt(e,n).intersect(i.bishopsAndQueens())).union(ge(e).intersect(i.knight)).union(me(e).intersect(i.king)).union(Yt(I(t),e).intersect(i.pawn)));class wt{constructor(){}static default(){const t=new wt;return t.castlingRights=d.corners(),t.rook={white:{a:0,h:7},black:{a:56,h:63}},t.path={white:{a:new d(14,0),h:new d(96,0)},black:{a:new d(0,234881024),h:new d(0,1610612736)}},t}static empty(){const t=new wt;return t.castlingRights=d.empty(),t.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},t.path={white:{a:d.empty(),h:d.empty()},black:{a:d.empty(),h:d.empty()}},t}clone(){const t=new wt;return t.castlingRights=this.castlingRights,t.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},t.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},t}add(t,i,n,r){const o=oi(t,i),s=si(t,i);this.castlingRights=this.castlingRights.with(r),this.rook[t][i]=r,this.path[t][i]=Wt(r,s).with(s).union(Wt(n,o).with(o)).without(n).without(r)}static fromSetup(t){const i=wt.empty(),n=t.castlingRights.intersect(t.board.rook);for(const r of Nt){const o=d.backrank(r),s=t.board.kingOf(r);if(!q(s)||!o.has(s))continue;const a=n.intersect(t.board[r]).intersect(o),l=a.first();q(l)&&l<s&&i.add(r,"a",s,l);const c=a.last();q(c)&&s<c&&i.add(r,"h",s,c)}return i}discardRook(t){if(this.castlingRights.has(t)){this.castlingRights=this.castlingRights.without(t);for(const i of Nt)for(const n of Fs)this.rook[i][n]===t&&(this.rook[i][n]=void 0)}}discardColor(t){this.castlingRights=this.castlingRights.diff(d.backrank(t)),this.rook[t].a=void 0,this.rook[t].h=void 0}}class Js{constructor(t){this.rules=t}reset(){this.board=xt.default(),this.pockets=void 0,this.turn="white",this.castles=wt.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){this.board=t.board.clone(),this.board.promoted=d.empty(),this.pockets=void 0,this.turn=t.turn,this.castles=wt.fromSetup(t),this.epSquare=ta(this,t.epSquare),this.remainingChecks=void 0,this.halfmoves=t.halfmoves,this.fullmoves=t.fullmoves}kingAttackers(t,i,n){return Xs(t,i,this.board,n)}playCaptureAt(t,i){this.halfmoves=0,i.role==="rook"&&this.castles.discardRook(t),this.pockets&&this.pockets[I(i.color)][i.promoted?"pawn":i.role]++}ctx(){const t=this.isVariantEnd(),i=this.board.kingOf(this.turn);if(!q(i))return{king:i,blockers:d.empty(),checkers:d.empty(),variantEnd:t,mustCapture:!1};const n=Bt(i,d.empty()).intersect(this.board.rooksAndQueens()).union(Tt(i,d.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[I(this.turn)]);let r=d.empty();for(const s of n){const a=Wt(i,s).intersect(this.board.occupied);a.moreThanOne()||(r=r.union(a))}const o=this.kingAttackers(i,I(this.turn),this.board.occupied);return{king:i,blockers:r,checkers:o,variantEnd:t,mustCapture:!1}}clone(){var t,i;const n=new this.constructor;return n.board=this.board.clone(),n.pockets=(t=this.pockets)===null||t===void 0?void 0:t.clone(),n.turn=this.turn,n.castles=this.castles.clone(),n.epSquare=this.epSquare,n.remainingChecks=(i=this.remainingChecks)===null||i===void 0?void 0:i.clone(),n.halfmoves=this.halfmoves,n.fullmoves=this.fullmoves,n}validate(){if(this.board.occupied.isEmpty())return H.err(new Pt(ut.Empty));if(this.board.king.size()!==2)return H.err(new Pt(ut.Kings));if(!q(this.board.kingOf(this.turn)))return H.err(new Pt(ut.Kings));const t=this.board.kingOf(I(this.turn));return q(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?H.err(new Pt(ut.OppositeCheck)):d.backranks().intersects(this.board.pawn)?H.err(new Pt(ut.PawnsOnBackrank)):H.ok(void 0):H.err(new Pt(ut.Kings))}dropDests(t){return d.empty()}dests(t,i){if(i=i||this.ctx(),i.variantEnd)return d.empty();const n=this.board.get(t);if(!n||n.color!==this.turn)return d.empty();let r,o;if(n.role==="pawn"){r=Yt(this.turn,t).intersect(this.board[I(this.turn)]);const s=this.turn==="white"?8:-8,a=t+s;if(0<=a&&a<64&&!this.board.occupied.has(a)){r=r.with(a);const l=this.turn==="white"?t<16:t>=48,c=a+s;l&&!this.board.occupied.has(c)&&(r=r.with(c))}q(this.epSquare)&&ia(this,t,i)&&(o=d.fromSquare(this.epSquare))}else n.role==="bishop"?r=Tt(t,this.board.occupied):n.role==="knight"?r=ge(t):n.role==="rook"?r=Bt(t,this.board.occupied):n.role==="queen"?r=ai(t,this.board.occupied):r=me(t);if(r=r.diff(this.board[this.turn]),q(i.king)){if(n.role==="king"){const s=this.board.occupied.without(t);for(const a of r)this.kingAttackers(a,I(this.turn),s).nonEmpty()&&(r=r.without(a));return r.union(Bi(this,"a",i)).union(Bi(this,"h",i))}if(i.checkers.nonEmpty()){const s=i.checkers.singleSquare();if(!q(s))return d.empty();r=r.intersect(Wt(s,i.king).with(s))}i.blockers.has(t)&&(r=r.intersect(Dn(t,i.king)))}return o&&(r=r.union(o)),r}isVariantEnd(){return!1}variantOutcome(t){}hasInsufficientMaterial(t){return this.board[t].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty()?!1:this.board[t].intersects(this.board.knight)?this.board[t].size()<=2&&this.board[I(t)].diff(this.board.king).diff(this.board.queen).isEmpty():this.board[t].intersects(this.board.bishop)?(!this.board.bishop.intersects(d.darkSquares())||!this.board.bishop.intersects(d.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty():!0}toSetup(){var t,i;return{board:this.board.clone(),pockets:(t=this.pockets)===null||t===void 0?void 0:t.clone(),turn:this.turn,castlingRights:this.castles.castlingRights,epSquare:ea(this),remainingChecks:(i=this.remainingChecks)===null||i===void 0?void 0:i.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return Nt.every(t=>this.hasInsufficientMaterial(t))}hasDests(t){t=t||this.ctx();for(const i of this.board[this.turn])if(this.dests(i,t).nonEmpty())return!0;return this.dropDests(t).nonEmpty()}isLegal(t,i){if(fe(t))return!this.pockets||this.pockets[this.turn][t.role]<=0||t.role==="pawn"&&d.backranks().has(t.to)?!1:this.dropDests(i).has(t.to);{if(t.promotion==="pawn"||t.promotion==="king"&&this.rules!=="antichess"||!!t.promotion!==(this.board.pawn.has(t.from)&&d.backranks().has(t.to)))return!1;const n=this.dests(t.from,i);return n.has(t.to)||n.has(na(this,t).to)}}isCheck(){const t=this.board.kingOf(this.turn);return q(t)&&this.kingAttackers(t,I(this.turn),this.board.occupied).nonEmpty()}isEnd(t){return(t?t.variantEnd:this.isVariantEnd())?!0:this.isInsufficientMaterial()||!this.hasDests(t)}isCheckmate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.nonEmpty()&&!this.hasDests(t)}isStalemate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.isEmpty()&&!this.hasDests(t)}outcome(t){const i=this.variantOutcome(t);return i||(t=t||this.ctx(),this.isCheckmate(t)?{winner:I(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(t)?{winner:void 0}:void 0)}allDests(t){t=t||this.ctx();const i=new Map;if(t.variantEnd)return i;for(const n of this.board[this.turn])i.set(n,this.dests(n,t));return i}play(t){const i=this.turn,n=this.epSquare,r=In(this,t);if(this.epSquare=void 0,this.halfmoves+=1,i==="black"&&(this.fullmoves+=1),this.turn=I(i),fe(t))this.board.set(t.to,{role:t.role,color:i}),this.pockets&&this.pockets[i][t.role]--,t.role==="pawn"&&(this.halfmoves=0);else{const o=this.board.take(t.from);if(!o)return;let s;if(o.role==="pawn"){this.halfmoves=0,t.to===n&&(s=this.board.take(t.to+(i==="white"?-8:8)));const a=t.from-t.to;Math.abs(a)===16&&8<=t.from&&t.from<=55&&(this.epSquare=t.from+t.to>>1),t.promotion&&(o.role=t.promotion,o.promoted=!!this.pockets)}else if(o.role==="rook")this.castles.discardRook(t.from);else if(o.role==="king"){if(r){const a=this.castles.rook[i][r];if(q(a)){const l=this.board.take(a);this.board.set(oi(i,r),o),l&&this.board.set(si(i,r),l)}}this.castles.discardColor(i)}if(!r){const a=this.board.set(t.to,o)||s;a&&this.playCaptureAt(t.to,a)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[i]=Math.max(this.remainingChecks[i]-1,0))}}class _s extends Js{constructor(){super("chess")}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const i=new this;return i.setupUnchecked(t),i.validate().map(n=>i)}clone(){return super.clone()}}const ta=(e,t)=>{if(!q(t))return;const i=e.turn==="white"?5:2,n=e.turn==="white"?8:-8;if(Ct(t)!==i||e.board.occupied.has(t+n))return;const r=t-n;if(!(!e.board.pawn.has(r)||!e.board[I(e.turn)].has(r)))return t},ea=e=>{if(!q(e.epSquare))return;const t=e.ctx(),n=e.board.pieces(e.turn,"pawn").intersect(Yt(I(e.turn),e.epSquare));for(const r of n)if(e.dests(r,t).has(e.epSquare))return e.epSquare},ia=(e,t,i)=>{if(!q(e.epSquare)||!Yt(e.turn,t).has(e.epSquare))return!1;if(!q(i.king))return!0;const n=e.turn==="white"?8:-8,r=e.epSquare-n;return e.kingAttackers(i.king,I(e.turn),e.board.occupied.toggle(t).toggle(r).with(e.epSquare)).without(r).isEmpty()},Bi=(e,t,i)=>{if(!q(i.king)||i.checkers.nonEmpty())return d.empty();const n=e.castles.rook[e.turn][t];if(!q(n)||e.castles.path[e.turn][t].intersects(e.board.occupied))return d.empty();const r=oi(e.turn,t),o=Wt(i.king,r),s=e.board.occupied.without(i.king);for(const c of o)if(e.kingAttackers(c,I(e.turn),s).nonEmpty())return d.empty();const a=si(e.turn,t),l=e.board.occupied.toggle(i.king).toggle(n).toggle(a);return e.kingAttackers(r,I(e.turn),l).nonEmpty()?d.empty():d.fromSquare(n)},In=(e,t)=>{if(fe(t))return;const i=t.to-t.from;if(!(Math.abs(i)!==2&&!e.board[e.turn].has(t.to))&&e.board.king.has(t.from))return i>0?"h":"a"},na=(e,t)=>{const i=In(e,t);if(!i)return t;const n=e.castles.rook[e.turn][i];return{from:t.from,to:q(n)?n:t.to}};var Li;(function(e){e.Fen="ERR_FEN",e.Board="ERR_BOARD",e.Pockets="ERR_POCKETS",e.Turn="ERR_TURN",e.Castling="ERR_CASTLING",e.EpSquare="ERR_EP_SQUARE",e.RemainingChecks="ERR_REMAINING_CHECKS",e.Halfmoves="ERR_HALFMOVES",e.Fullmoves="ERR_FULLMOVES"})(Li||(Li={}));const ra=e=>{let t=It(e.role);return e.color==="white"&&(t=t.toUpperCase()),e.promoted&&(t+="~"),t},oa=e=>{let t="",i=0;for(let n=7;n>=0;n--)for(let r=0;r<8;r++){const o=r+n*8,s=e.get(o);s?(i>0&&(t+=i,i=0),t+=ra(s)):i++,r===7&&(i>0&&(t+=i,i=0),n!==0&&(t+="/"))}return t},Ki=e=>te.map(t=>It(t).repeat(e[t])).join(""),sa=e=>Ki(e.white).toUpperCase()+Ki(e.black),aa=(e,t)=>{let i="";for(const n of Nt){const r=d.backrank(n);let o=e.kingOf(n);q(o)&&!r.has(o)&&(o=void 0);const s=e.pieces(n,"rook").intersect(r);for(const a of t.intersect(r).reversed())if(a===s.first()&&q(o)&&a<o)i+=n==="white"?"Q":"q";else if(a===s.last()&&q(o)&&o<a)i+=n==="white"?"K":"k";else{const l=de[V(a)];i+=n==="white"?l.toUpperCase():l}}return i||"-"},ca=e=>`${e.white}+${e.black}`,ha=(e,t)=>[oa(e.board)+(e.pockets?`[${sa(e.pockets)}]`:""),e.turn[0],aa(e.board,e.castlingRights),q(e.epSquare)?Fe(e.epSquare):"-",...e.remainingChecks?[ca(e.remainingChecks)]:[],Math.max(0,Math.min(e.halfmoves,9999)),Math.max(1,Math.min(e.fullmoves,9999))].join(" "),la=(e,t)=>{let i="";if(fe(t))t.role!=="pawn"&&(i=It(t.role).toUpperCase()),i+="@"+Fe(t.to);else{const n=e.board.getRole(t.from);if(!n)return"--";if(n==="king"&&(e.board[e.turn].has(t.to)||Math.abs(t.to-t.from)===2))i=t.to>t.from?"O-O":"O-O-O";else{const r=e.board.occupied.has(t.to)||n==="pawn"&&V(t.from)!==V(t.to);if(n!=="pawn"){i=It(n).toUpperCase();let o;if(n==="king"?o=me(t.to).intersect(e.board.king):n==="queen"?o=ai(t.to,e.board.occupied).intersect(e.board.queen):n==="rook"?o=Bt(t.to,e.board.occupied).intersect(e.board.rook):n==="bishop"?o=Tt(t.to,e.board.occupied).intersect(e.board.bishop):o=ge(t.to).intersect(e.board.knight),o=o.intersect(e.board[e.turn]).without(t.from),o.nonEmpty()){const s=e.ctx();for(const a of o)e.dests(a,s).has(t.to)||(o=o.without(a));if(o.nonEmpty()){let a=!1,l=o.intersects(d.fromRank(Ct(t.from)));o.intersects(d.fromFile(V(t.from)))?a=!0:l=!0,l&&(i+=de[V(t.from)]),a&&(i+=Kn[Ct(t.from)])}}}else r&&(i=de[V(t.from)]);r&&(i+="x"),i+=Fe(t.to),t.promotion&&(i+="="+It(t.promotion).toUpperCase())}}return i},ua=(e,t)=>{var i;const n=la(e,t);return e.play(t),!((i=e.outcome())===null||i===void 0)&&i.winner?n+"#":e.isCheck()?n+"+":n},Di=(e,t)=>ua(e.clone(),t),Fi=(e,t)=>{const i=e.ctx(),n=t.match(/^([NBRQK])?([a-h])?([1-8])?[-x]?([a-h][1-8])(?:=?([nbrqkNBRQK]))?[+#]?$/);if(!n){let p;if(t==="O-O"||t==="O-O+"||t==="O-O#"?p="h":(t==="O-O-O"||t==="O-O-O+"||t==="O-O-O#")&&(p="a"),p){const k=e.castles.rook[e.turn][p];return!q(i.king)||!q(k)||!e.dests(i.king,i).has(k)?void 0:{from:i.king,to:k}}const m=t.match(/^([pnbrqkPNBRQK])?@([a-h][1-8])[+#]?$/);if(!m)return;const P={role:m[1]?$t(m[1]):"pawn",to:Ht(m[2])};return e.isLegal(P,i)?P:void 0}const r=n[1]?$t(n[1]):"pawn",o=Ht(n[4]),s=n[5]?$t(n[5]):void 0;if(!!s!==(r==="pawn"&&d.backranks().has(o))||s==="king"&&e.rules!=="antichess")return;let a=e.board.pieces(e.turn,r);r==="pawn"&&!n[2]?a=a.intersect(d.fromFile(V(o))):n[2]&&(a=a.intersect(d.fromFile(n[2].charCodeAt(0)-97))),n[3]&&(a=a.intersect(d.fromRank(n[3].charCodeAt(0)-49)));const l=r==="pawn"?d.fromFile(V(o)):d.empty();a=a.intersect(l.union(Ws({color:I(e.turn),role:r},o,e.board.occupied)));let c;for(const p of a)if(e.dests(p,i).has(o)){if(q(c))return;c=p}if(q(c))return{from:c,to:o,promotion:s}};async function da(){try{const e=await fetch("https://lichess.org/api/puzzle/daily");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const i=await e.json();return{initialPly:i.puzzle.initialPly,solution:i.puzzle.solution,pgn:i.game.pgn}}catch(e){throw new Error(`HTTP error! status: ${e}`)}}async function fa(){let e=_s.fromSetup(Gs()).unwrap();const t=await da(),i=t.pgn.split(" ");for(let s=0;s<t.initialPly;s++){const a=Fi(e,i[s]);if(a===void 0)throw new Error(`Cannot parse move ${i[s]}`);e.play(a)}const n=ha(e.toSetup());let r=[];const o=Fi(e,i[t.initialPly]);if(o===void 0)throw new Error(`Cannot parse move ${i[t.initialPly]}`);r.push(Di(e,o)),e.play(o);for(let s=0;s<t.solution.length;s++){const a=$s(t.solution[s]);if(a===void 0)throw new Error(`Can't parse puzzle solution ${t.solution[s]}`);r.push(Di(e,a)),e.play(a)}return`[FEN "${n}"]

${r.join(" ")}`}const pa=await fa();Ds(document.getElementById("puzzle"),pa,!0);
